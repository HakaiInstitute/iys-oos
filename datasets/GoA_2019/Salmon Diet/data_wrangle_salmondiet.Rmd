---
title: "2019 IYS - Salmon Diet Data wrangle"
author: "Tim van der Stap"
date: "7/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(janitor)
library(readxl)
library(here)
library(parsedate)
library(googledrive)
library(uuid)
```

The raw data is stored on GoogleDrive. The first step is to download the file from Google Drive to a local folder on your computer's hard drive. 

``` {r file_download, eval = FALSE}
# Make sure your folder path exists already (e.g. ./Salmon Diet/raw_data)
drive_download("https://docs.google.com/spreadsheets/d/1E88ZXuiYIqjq4ABl2GDB7Kp0UAG-0tIM/edit#gid=2020388317", 
               path = here::here("Salmon Diet", "raw_data", 
                                 "GoA_fish diets_cleaned.xlsx"),
               overwrite = TRUE)
```

When creating the different eventID layers, we assume that the column `Trawl` is synonymous to `Station` -- need to confirm this! Additionally, in the current set up, each salmon species caught at a specific station gets treated like a unique sample ID (and, thus, as a unique `eventID`). Ideally, the salmon that were caught and dissected would have been given a Floy tag, so a distinction can be made between stomach content of different individuals of a same species in the same trawl. 

To do: Confirm model structure for salmon diet data. Current problem: Multiple individuals of the same species were caught in a single trawl, however within the dataset there is no column to indicate how these individual measurements are separate (i.e., no SampleID associated to each individual fish). Perhaps we should add a SampleID column ourselves, or, alternatively, associate two occurrence cores (fish metrics / fish stomach content) to a single occurrence core?

``` {r data wrangle, eval = FALSE}
salmon <- read_excel(here("Salmon Diet", "raw_data", 
                       "GoA_fish diets_cleaned.xlsx"), 
                  sheet = "Diets_clean") %>%
  janitor::clean_names() %>%
  mutate(cruise = "GoA2019",
         station = paste(cruise, trawl, sep="_Stn"),
         trawl = paste(station, "trawl1", sep=":"),
         sample = paste(trawl, species, sep=":")
  )
```

No metadata is mentioned in the Salmon Diet data as to when and where the trawls took place. To connect the coordinates and time to the eventIDs, this information is taken from the trawl datasheet. Right now I am saving both these files in the Salmon Diet folder, but once all folders and scripts have been QC'd the location/time can be read straight from the Trawl-specific folder. For now, I'm afraid it would cause confusion when committing/pushing to GitHub. 

``` {r salmon_datetime, eval = FALSE}
drive_download(file = "https://docs.google.com/spreadsheets/d/1rtT6L5WSi_UiiXfoS95wnDqA8loc959T/edit#gid=668595086", 
               path = here::here("Salmon Diet", "raw_data", 
                                 "2019_GoA_Fish_data_Hakai.xlsx"),
               overwrite = TRUE)

trawl <- read_excel(here("Salmon Diet", "raw_data", "2019_GoA_Fish_data_Hakai.xlsx")) %>%
  mutate(eventDate = format_iso_8601(as.POSIXct(UTC_start)),
         eventDate = str_replace(eventDate, "\\+00:00", "Z")

```

Please note that the date - given that it's currently from a .xlsx file that is not considered the final datasheet - could change. Will need to make sure that the correct excel file is read. 

``` {r bongo_event, eval = FALSE}
salmon_cruise <- salmon %>% 
  select(eventID = cruise) %>%
  distinct(eventID) %>%
  mutate(eventRemarks = "cruise")

salmon_station <- salmon %>%
  select(eventID = station,
         parentEventID = cruise) %>% 
  distinct(eventID, .keep_all = TRUE) %>% 
  mutate(eventRemarks = "station")

# Join date and coordinates to trawl. Remember that the date and coordinates are not from the Salmon Diet data sheet, but from the trawl data sheet. Should minimum and maximum depth of the trawl be included here as well if the information becomes available? 
salmon_trawl <- salmon %>%
  select(eventID = trawl,
         parentEventID = station,
         eventDate = 
         decimalLatitude = 
         decimalLongitude = ) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate(eventRemarks = "trawl")

# The Salmon Diet data does not include information as to at what depths the trawls were conducted. Currently I believe this information is also not present in the general Trawl data. Should this information become available it should be connected to the general trawl information, along with info such as: volume water filter, speed at which the vessel was traveling during trawl, starting & finish lat/longs of trawl. 

# If we opt for two occurrence cores that are connected to the eventID through a common occurrenceID, then the following lines of code are not necessary: 

salmon_sample <- salmon %>% 
  select(eventID = sample,
         parentEventID = trawl,
         minimumDepthInMetres = 
         maximumDepthInMetres = ) %>% 
  distinct(eventID, .keep_all = TRUE) %>% 
  mutate(eventRemarks = "sample")

# To connect them all together: 
salmon_event <- bind_rows(salmon_cruise,salmon_station,salmon_trawl, salmon_sample) %>%
  select(eventID, parentEventID:maximumDepthInMetres, eventRemarks) %>%
  mutate(type = "HumanObservation")

# Should sample_type be included in the Event Core, under the heading samplingProtocol? 

# Make sure the folder path exists already (e.g. ./Salmon Diet/tidy_data)
write_csv(bongo_event, here("Salmon Diet", "tidy_data", "salmon_event.csv"))
drive_upload(here("Salmon Diet", "tidy_data", "salmon_event.csv"),
             path = " ",
             name = "salmon_event.csv",
             overwrite = TRUE)
```

The current proposed set up would include two occurrence cores that are connected to the eventID through a common occurrence core. Currently however this does not seem to be possible, as within the datasheet there is no column designated to i.e., sampleID. The problem with this is that there are sometimes numerous individuals of the same species caught at a station/within a trawl, but no these individuals have no defining tag (so how do the scientists know which individual the stomach content belong to, asides from their data?)

In one of the occurrence cores I think we should list all the unique prey species consumed by the salmon. The measurements attached to these unique occurrences would be the mass (g) of prey consumed. Each prey species will receive their own unique URN from [WoRMS](http://www.marinespecies.org/)

``` {r prey_occurrence, eval = FALSE}
# As all the prey species are listed as columns, we first have investigate all the unique prey species consumed, as these will get their associated WoRMS URN. There is also a column `digested_food` which will not have an associated URN. 
str(salmon)

# What to do with the column 'digested_food"? Sounds like it's 'unidentified species'. Occurrence of prey present or absent based on whether mass (g) has been recorded in the stomach content. 

salmon_prey <- salmon %>%
  pivot_longer(cols = boreoteuthis_borealis:mictostomus_pacificus, names_to = "scientificName", values_to = "Mass") %>%
  mutate(occurrenceStatus = ifelse(Mass > 0, "present", "absent"),
         occurrenceID = paste(trawl, species, scientificName, sep = ":"),
         scientificNameID = case_when(
  # I am not happy with the occurrenceID but this is just a set-up for now. 
scientificName == "boreoteuthis_borealis" ~ "urn:lsid:marinespecies.org:taxname:342326",
# Boreoteuthis is not an accepted genus, Gonatopsis is the accepted version?
scientificName == "neocalanus_cristatus" ~ "urn:lsid:marinespecies.org:taxname:104470",
scientificName == "pisces" ~ "urn:lsid:marinespecies.org:taxname:1167",
scientificName == "tomopteris" ~ "urn:lsid:marinespecies.org:taxname:11676",
scientificName == "chuneola_major" ~ "urn:lsid:marinespecies.org:taxname:431286" ,
scientificName == "sergestes_pacificus" ~ " ",
# Is only the atlantic version accepted?
scientificName == "e_pacifica" ~ "urn:lsid:marinespecies.org:taxname:237851",
scientificName == "tarletonbeania_crenularis" ~ "urn:lsid:marinespecies.org:taxname:282927",
scientificName == "hyperia_sp" ~ "urn:lsid:marinespecies.org:taxname:101796",
scientificName == "clione_limacina" ~ "urn:lsid:marinespecies.org:taxname:139178",
scientificName == "th_spinifera" ~ " ",
# Unsure whether th. stands for Thalamita, Thyone, or Thysanoessa
scientificName == "coelenterata" ~ "urn:lsid:marinespecies.org:taxname:2",
# Coelenterata is a term encompassing the animal phyla Cnidaria and Ctenophora? 
# Therefore the lowest common rank is the kingdom Animalia
scientificName == "vanadis_sp" ~ "urn:lsid:marinespecies.org:taxname:129150",
scientificName == "sagitta_elegans" ~ "urn:lsid:marinespecies.org:taxname:105440",
# The accepted name is Parasagitta elegans
scientificName == "salpa_aspera" ~ "urn:lsid:marinespecies.org:taxname:137270",
scientificName == "cyclosalpa" ~ "urn:lsid:marinespecies.org:taxname:137227", 
scientificName == "th_longipes" ~ " ",
# Unsure whether the `th` is for Thalassarachna, Thalassomyia, Thalestris, Thaumatops or Thysanoessa
# Likely Thysanoessa given that th_spinifera is also listed, but have to confirm. 
scientificName == "cephalopoda" ~ "urn:lsid:marinespecies.org:taxname:11707",
scientificName == "phronima_sedentaria" ~ "urn:lsid:marinespecies.org:taxname:103272",
scientificName == "oikopleura" ~ "urn:lsid:marinespecies.org:taxname:103367",
scientificName == "isopoda" ~ "urn:lsid:marinespecies.org:taxname:1131",
scientificName == "clio_pyramidata" ~ "urn:lsid:marinespecies.org:taxname:139033",
scientificName == "chormiphora_cucumis" ~ "urn:lsid:marinespecies.org:taxname:106382"
# Accepted name is Hormiphora cucumis?
scientificName == "symbolophorus_californiensis" ~ "urn:lsid:marinespecies.org:taxname:272733",
scientificName == "okutania_anonycha" ~ "urn:lsid:marinespecies.org:taxname:342285",
# Is the accepted name Berryteuthis anonychus?
scientificName == "sebastes" ~ "urn:lsid:marinespecies.org:taxname:126175",
scientificName == "mictostomus_pacificus" ~ "urn:lsid:marinespecies.org:taxname:274294")
# Spelling error? Accepted name is Microstomus pacificus?
) %>%
  rename(eventID = trawl)

salmon_prey_occ <- salmon_prey %>%
  select(eventID, occurreceID, scientificName, scientificNameID, occurrenceStatus) %>%
  mutate(basisOfRecord = "HumanObservation")

# Make sure the folder path exists already (e.g. ./Salmon Diet/tidy_data)
write_csv(salmon_prey_occ, here("Salmon Diet", "tidy_data", "salmon_prey_occ.csv"))
drive_upload(here("Salmon Diet", "tidy_data", "salmon_prey_occ.csv"),
             path = " ",
             name = "salmon_prey_occ.csv",
             overwrite = TRUE)
```

There are two occurrence cores, one for the prey species consumed by the individual salmon, and an occurrence core for each salmon species dissected. To the salmon_prey occurrence core, measurements include presence/absence of whether a prey species has been consumed, and how much (mass - gram). Measurements linked to the salmon individual include: forklength, mass, food mass, GFI, CFI adj % and `N stomachs` (though have to see how this last one fits in). 
``` {r salmon_occ, eval = FALSE}
salmon_spp_occ <- salmon %>%
  # Given that the expedition was targeted to salmon species, for each station we'll include whether each of the five salmon species were caught (present) or not (absent): 
  complete(trawl, species, fill = list(n_stomachs = 0)) %>%
  fill(salmon, .direction = "downup") %>%
  mutate(occurrenceStatus = ifelse(n_stomachs > 0, "present", "absent"),
         occurrenceID = paste(trawl, species, sep = ":"),
         scientificNameID = case_when(
scientificName == "Oncorhynchus gorbuscha" ~ "urn:lsid:marinespecies.org:taxname:127182",
scientificName == "Oncorhynchus kisutch" ~ "urn:lsid:marinespecies.org:taxname:127184",
scientificName == "Oncorhynchus keta" ~ "urn:lsid:marinespecies.org:taxname:127183",
scientificName == "Oncorhynchus nerka" ~ "urn:lsid:marinespecies.org:taxname:254569",
scientificName == "Oncorhynchus tschawytscha" ~ "urn:lsid:marinespecies.org:taxname:158075")) %>%
  # Accepted name has slightly different species name: O. tshawytscha
  rename(eventID = trawl)

# Make sure the folder path exists already (e.g. ./Salmon Diet/tidy_data)
write_csv(salmon_spp_occ, here("Salmon Diet", "tidy_data", "salmon_spp_occ.csv"))
drive_upload(here("Salmon Diet", "tidy_data", "salmon_spp_occ.csv"),
             path = " ",
             name = "salmon_spp_occ.csv",
             overwrite = TRUE)
```

So given that we have two occurrence cores for Salmon Diet data, there are also two measurementOr
