---
title: "data_wrangle_trawl"
author: "Tim van der Stap & Julian Gan"
date: "5/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
library(tidyverse)
library(lubridate)
library(readxl)
library(here)
library(parsedate)
library(googledrive)
library(uuid)
```

The first step is to download the file from GoogleDrive and save it in a local folder: 

``` {r file_download}
drive_download(file = "https://docs.google.com/spreadsheets/d/1rtT6L5WSi_UiiXfoS95wnDqA8loc959T/edit#gid=668595086", 
               path = here::here("Trawl", "raw_data", 
                                 "2019_GoA_Fish_data_Hakai.xlsx"),
               overwrite = TRUE)
```

The trawl data is read from the local folder, and the date/time is formatted to the iso 8601 standards. Additionally, three extra columns are created for each `eventID`: "cruise", "station" and "trawl". Currently, the column `NUMBER` refers to the trawl set number, but it is unclear whether this is synonymous to Station. Station is not specifically recorded, and a total of 63 unique NUMBERs are recorded. We will need confirmation that NUMBER refers to a unique trawl done at a station. Regardless, we add an additional layer of `Trawl` under `Station` should multiple trawls be undertaken at a single station (in the future).

``` {r trawl_data_prep}
trawl <- read_excel(here("Trawl", "raw_data", "2019_GoA_Fish_data_Hakai.xlsx")) %>%
  mutate(eventDate = format_iso_8601(as.POSIXct(UTC_start)),
         eventDate = str_replace(eventDate, "\\+00:00", "Z"),
         cruise = "GoA2019", 
         station = paste(cruise, NUMBER, sep="_Stn"),
         trawl = paste(station, "trawl1", sep=":"))
```

## Event Core 

Next, dataframes are created for each unique `eventID` layer, with unique associated columns. Eventually, the data frames get joined, and the event table gets saved locally and in Google Drive. 

``` {r trawl_event}
trawl_cruise <- trawl %>% 
  select(eventID = cruise) %>% 
  distinct(eventID) %>% 
  mutate(type = "cruise")

trawl_station <- trawl %>% 
  select(eventID = station,
         parentEventID = cruise,
         eventDate,
         decimalLatitude = Y,
         decimalLongitude = X) %>% 
  distinct(eventID, .keep_all = TRUE) %>% 
  mutate(type = "station")

trawl_trawl <- trawl %>% 
  select(eventID = trawl,
         parentEventID = station) %>% 
  distinct(eventID, .keep_all = TRUE) %>% 
  mutate(type = "trawl")

trawl_event <- bind_rows(trawl_cruise, trawl_station, trawl_trawl) %>% 
  select(eventID, parentEventID:decimalLongitude, type)

# Re-order the Event Core:
order <- stringr::str_sort(trawl_event$eventID, numeric=TRUE)
trawl_event <- trawl_event[match(order, trawl_event$eventID),] %>%
  mutate(basisOfRecord = "HumanObservation")

write_csv(trawl_event, here("Trawl", "tidy_data", "trawl_event.csv"))
drive_upload(here("Trawl", "tidy_data", "trawl_event.csv"),
             path = "",
             name = "trawl_event.csv",
             overwrite = TRUE)
```

## Occurrence

As the trawl data consists of biotic data, an occurrence table has to be created as well, whereby unique species `occurrenceIDs` get linked to the `eventID`. As genus and species level were recorded in separate columns, these first get joined. A required column for the Occurrence table is `OccurrenceStatus`, indicating whether a species was sighted in a trawl. Therefore, a list is created of all unique spp sighted throughout the expedition, and for each species that was not caught during a trawl a "zero" catch is added. Finally, the `occurrenceStatus` column is populated based on whether or not a species was caught (PIECES > 0). 

``` {r data_prep_occ}
trawl <- trawl %>%
  mutate(Species = paste(FISH1, FISH2, sep = " "))

# Determine the unique species caught throughout the entire expedition, to 
# determine whether these are present or absent at each station. 
unique_spp <- unique(trawl$Species)
length(unique_spp)

# So a total of 46 unique species have been caught throughout the expedition.
# For each trawl, note for each of these species whether it was present or absent:

trawl_occ <- trawl %>% tidyr::complete(NUMBER, Species, 
                                       fill = list(PIECES=0)) %>%
  as.data.frame()
trawl_occ <- trawl_occ %>% group_by(NUMBER) %>% fill(trawl) %>%
  fill(trawl, .direction = "up") %>% ungroup(NUMBER)

# Add present or absent depending on whether "Pieces > 0"
trawl_occ <- trawl_occ %>% 
  mutate(occurrenceStatus = ifelse(PIECES > 0, "present", "absent")) %>%
  dplyr::rename(scientificName = Species) %>%
  select(eventID = trawl, 
         scientificName, occurrenceStatus)
```

Next, `occurrenceID` - unique to each species at each station - and `scientificNameID` are populated. For the `scientificNameID`, we look up the species on the WoRMS website (http://www.marinespecies.org/). It is important to take into account whether or not a species name has been "accepted" by WoRMS or not, and, should this not be the case, what is the correct name and species identifier.

``` {r trawl_occ}
trawl_occ <- trawl_occ %>% 
  mutate(occurrenceID = paste("occ", row_number(), sep = "_"),
         scientificNameID = case_when(
           scientificName == "Abraliopsis felis" ~ "urn:lsid:marinespecies.org:taxname:341849",
           scientificName == "Aequorea sp." ~ "urn:lsid:marinespecies.org:taxname:116998",
           scientificName == "Anotopterus nikparini" ~ "urn:lsid:marinespecies.org:taxname:272040",
           scientificName == "Aptocyclus ventricosus" ~ "urn:lsid:marinespecies.org:taxname:254299",
           scientificName == "Aurelia labiata" ~ "urn:lsid:marinespecies.org:taxname:287213",
           scientificName == "Aurelia limbata" ~ "urn:lsid:marinespecies.org:taxname:158199",
           scientificName == "Belonella borealis" ~ "urn:lsid:marinespecies.org:taxname:410406",
           scientificName == "Boreoteuthis borealis" ~ "urn:lsid:marinespecies.org:taxname:342326",
           # Different genus name to what was provided: Gonatopsis vs. Boreoteuthis
           scientificName == "Calycopsis sp." ~ "urn:lsid:marinespecies.org:taxname:117028",
           scientificName == "Chiroteuthis calyx" ~ "urn:lsid:marinespecies.org:taxname:341796",
           scientificName == "Chrysaora melonaster" ~ "urn:lsid:marinespecies.org:taxname:287209",
           # Slightly different spelling of species name
           scientificName == "Corolla calceola" ~ "urn:lsid:marinespecies.org:taxname:532663",
           scientificName == "Diaphus theta" ~ "urn:lsid:marinespecies.org:taxname:272694",
           scientificName == "Gasterosteus aculeatus" ~ "urn:lsid:marinespecies.org:taxname:126505",
           scientificName == "Gonatidae sp." ~ "urn:lsid:marinespecies.org:taxname:11743",
           scientificName == "Gonatus madokai" ~ "urn:lsid:marinespecies.org:taxname:341858",
           scientificName == "Gonatus onyx" ~ "urn:lsid:marinespecies.org:taxname:341859",
           scientificName == "Gonatus sp." ~ "urn:lsid:marinespecies.org:taxname:138036",
           scientificName == "Hormiphora cucumis" ~ "urn:lsid:marinespecies.org:taxname:106382",
           scientificName == "Icichthys lockingtoni" ~ "urn:lsid:marinespecies.org:taxname:279354",
           scientificName == "Japetella diaphana" ~ "urn:lsid:marinespecies.org:taxname:138849",
           scientificName == "Lestidium ringens" ~ "urn:lsid:marinespecies.org:taxname:272096",
           # slightly different accepted name than what was recorded
           scientificName == "Lipolagus ochotensis" ~ "urn:lsid:marinespecies.org:taxname:281374",
           scientificName == "Microstomus pacificus" ~ "urn:lsid:marinespecies.org:taxname:274294",
           scientificName == "Moroteuthis robusta" ~ "urn:lsid:marinespecies.org:taxname:410385",
           # different genus name than what was recorded
           scientificName == "Oncorhynchus gorbuscha" ~ "urn:lsid:marinespecies.org:taxname:127182",
           scientificName == "Oncorhynchus keta" ~ "urn:lsid:marinespecies.org:taxname:127183",
           scientificName == "Oncorhynchus kisutch" ~ "urn:lsid:marinespecies.org:taxname:127184",
           scientificName == "Oncorhynchus nerka" ~ "urn:lsid:marinespecies.org:taxname:254569",
           scientificName == "Oncorhynchus tschawytscha" ~ "urn:lsid:marinespecies.org:taxname:158075",
           scientificName == "Onychoteuthis borealijaponica" ~ "urn:lsid:marinespecies.org:taxname:342069",
           scientificName == "Paralepididae gen. sp." ~ "urn:lsid:marinespecies.org:taxname:125447",
           scientificName == "Periphylla periphylla" ~ "urn:lsid:marinespecies.org:taxname:135294",
           scientificName == "Phacellophora camtshchatica" ~ "urn:lsid:marinespecies.org:taxname:135309",
           # Slightly different spelling
           scientificName == "Salpa sp." ~ "urn:lsid:marinespecies.org:taxname:137233",
           scientificName == "Sebastes melanops" ~ "urn:lsid:marinespecies.org:taxname:274817",
           scientificName == "Sergestes similis" ~ "urn:lsid:marinespecies.org:taxname:514127",
           # Different accepted genus name
           scientificName == "Siphonophora sp." ~ "urn:lsid:marinespecies.org:taxname:1371",
           scientificName == "Squalus acanthias" ~ "urn:lsid:marinespecies.org:taxname:105923",
           scientificName == "Stenobrachius leucopsarus" ~ "urn:lsid:marinespecies.org:taxname:254363",
           scientificName == "Symbolophorus californiense" ~ "urn:lsid:marinespecies.org:taxname:272733",
           # Slightly different species name spelling
           scientificName == "Tarletonbeania crenularis" ~ "urn:lsid:marinespecies.org:taxname:282927",
           scientificName == "Thalassenchelys coheni" ~ "urn:lsid:marinespecies.org:taxname:282952",
           scientificName == "Thetys vagina" ~ "urn:lsid:marinespecies.org:taxname:137281",
           scientificName == "Thysanoessa spinifera" ~ "urn:lsid:marinespecies.org:taxname:237874",
           scientificName == "Zaprora silenus" ~ "urn:lsid:marinespecies.org:taxname:254353"
# Please take into account whether or not the Status of the species on WoRMS is 
# accepted or not!
         )) %>%
  select(eventID, occurrenceID, scientificName, scientificNameID, occurrenceStatus)
```

Finally, we just want to do a quick check to make sure that all the unique species are included in the trawl_occ dataframe, at each station (`eventID`)! We need to make sure that the output is TRUE. If confirmed, the Occurrence table can be saved locally and in the correct Google Drive folder. 

``` {r trawl_occ_check}
check_spp <- trawl_occ %>% group_by(eventID) %>%
  summarise(count = n_distinct(scientificNameID)) 
if(check_spp$count[i] == length(unique_spp)) {
    print("TRUE") 
  } else {
    print("FALSE")
  }

write_csv(trawl_occ, here("Trawl", "tidy_data", "trawl_occ.csv"))
drive_upload(here("Trawl", "tidy_data", "trawl_occ.csv"),
             path = "",
             name = "trawl_occ.csv",
             overwrite = TRUE)
```


