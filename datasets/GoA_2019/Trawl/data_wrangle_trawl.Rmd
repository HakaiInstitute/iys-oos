---
title: "data_wrangle_trawl"
author: "Tim van der Stap & Julian Gan"
date: "5/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
library(tidyverse)
library(lubridate)
library(readxl)
library(here)
library(worrms)
library(obistools)
library(parsedate)
library(googledrive)
library(uuid)
```

The first step is to download the file from GoogleDrive and save it in a local folder: 

``` {r file_download}
drive_download(file = "https://docs.google.com/spreadsheets/d/1xm_MIx_y8nsvA8I-7G33RcQ_j7w-Qmm-/edit#gid=168338968", 
               path = here::here("Trawl", "raw_data", 
                                 "2020_GoA_Fish_Trawl_data.xlsx"),
               overwrite = TRUE)
```

The trawl data is read from the local folder, and the date/time is formatted to the iso 8601 standards. Additionally, four extra columns are created for each `eventID`: "project", "cruise", "station" and "trawl". The fish trawl abundance data file also includes the bridgelog file sheet, where metadata is recorded. When reading the data in from the local folder make sure that a clear distinction is made between the bridgelog (metadata) and the catch data. 

``` {r trawl_data_prep}
trawl2020 <- read_excel(here("Trawl", "raw_data", "2020_GoA_Fish_Trawl_data.xlsx"), sheet = "BRIDGE_LOG_FINAL") %>%
  mutate(Time = format(TIME_FISHING_START, "%H:%M:%S"),
         eventDate = format_iso_8601(as.POSIXct(paste(EVENT_DATE, Time),
                                                format = "%Y-%m-%d %H:%M:%S",
                                                tz = "Asia/Kamchatka")), # Confirm this timezone. 
         eventDate = str_replace(eventDate, "\\+00:00", "Z"),
         project = "IYS",
         cruise = paste(project, "GoA2020", sep = ":"), 
         station = paste(cruise, SET_NUMBER, sep="_Stn"),
         trawl = paste(station, "trawl", sep=":"))
```

## Event Core 

Next, dataframes are created for each unique `eventID` layer, with unique associated columns. Eventually, the data frames get joined, and the event table gets saved locally and in Google Drive. The column `eventRemarks` is not a required column, but includes descriptive information pertaining to any issues that arose during the setting of the trawl net. 

``` {r trawl_event, eval = FALSE}
trawl2020_project <- trawl2020 %>%
  select(eventID = project) %>%
  distinct(eventID)

trawl2020_cruise <- trawl2020 %>% 
  select(eventID = cruise,
         parentEventID = project) %>% 
  distinct(eventID, .keep_all = TRUE) 

trawl2020_station <- trawl2020 %>% 
  select(eventID = station,
         parentEventID = cruise) %>% 
  distinct(eventID, .keep_all = TRUE) 

# The coordinates associated to the trawl need to be presented in a LINESTRING:
trawl2020_coordinates <- trawl2020 %>%
  select(eventID = trawl,
         START_LAT_DECDEGREE,
         START_LONG_DECDEGREE,
         END_LAT_DECDEGREE,
         END_LONG_DECDEGREE) %>%
  mutate(footprintWKT = paste("LINESTRING (", START_LONG_DECDEGREE, START_LAT_DECDEGREE, ",", 
                              END_LONG_DECDEGREE, END_LAT_DECDEGREE, ")")) %>%
  filter(!is.na(END_LAT_DECDEGREE)) # Station 20 needs end lat and long included - this issue needs to be resolved. 

trawl2020_linestring <- obistools::calculate_centroid(trawl2020_coordinates$footprintWKT)
trawl2020_linestring <- cbind(trawl2020_coordinates, trawl2020_linestring) %>%
  select(eventID, footprintWKT, decimalLatitude, decimalLongitude, coordinateUncertaintyInMeters)

trawl2020_trawl <- trawl2020 %>% 
  select(eventID = trawl,
         parentEventID = station,
         eventDate,
         fieldNotes = PROBLEM_DESCRIPTION
         ) %>%
  mutate(minimumDepthInMeters = 0, # trawl was at the surface
         maximumDepthInMeters = pmax(trawl2020$`NET OPENING DEPTH (metres) - 15 min`,
                                     trawl2020$`NET OPENING DEPTH (metres) - 30 min`,
                                     trawl2020$`NET OPENING DEPTH (metres) - 45 min`,
                                     trawl2020$`NET OPENING DEPTH (metres) - END`, na.rm = TRUE),
         samplingProtocol = "surface trawl", # if possible add DOI to paper here
         sampleSizeValue = trawl2020$`DURATION OF TOW (min)`,
         sampleSizeUnit = "min",
         waterBody = case_when(
           trawl2020$LOCATION == "GoA" ~ "Gulf of Alaska"),
         locationRemarks = case_when(
           trawl2020$LOCATION == "Canadian EEZ" ~ "Canadian EEZ")
         ) %>%
  left_join(trawl2020_linestring, by = "eventID") %>% 
  distinct(eventID, .keep_all = TRUE)

trawl2020_event <- bind_rows(trawl2020_project, trawl2020_cruise, trawl2020_station, trawl2020_trawl) %>% 
  mutate(type = "Event")

# Re-order the Event Core if required:
# order <- stringr::str_sort(trawl_event$eventID, numeric=TRUE)
# trawl_event <- trawl_event[match(order, trawl_event$eventID),] 

write_csv(trawl_event, here("Trawl", "tidy_data", "trawl_event.csv"))
drive_upload(here("Trawl", "tidy_data", "trawl_event.csv"),
             path = "https://drive.google.com/drive/folders/1MQ6XJQqnWk2puDaBTfHn7wXITjDSeLR7",
             name = "trawl_event.csv",
             overwrite = TRUE)
```

## Occurrence

As the trawl data consists of biotic data, an occurrence table has to be created as well, whereby unique species `occurrenceIDs` get linked to the `eventID`. As genus and species level were recorded in separate columns, these first get joined. A required column for the Occurrence table is the term, `occurrenceStatus`, which is used for presence/absence data. We initially considered creating a cruise-wide list of all unique species observed, and create "absent" records for each species not observed in a particular trawl (i.e., `PIECES` = 0). We decided not to do this for all species, and create absent records only for the five Pacific salmon species, because we did not want to interpolate the data to assume "truely" absentee status for species for which the trawls were not designed to catch (i.e., creating false negatives for species occurrence at a station). 

Next, `occurrenceID` - unique to each species _and each group (i.e. adult or juvenile)_ at each station - and `scientificNameID` are populated. For the `scientificNameID`, we look up the species on the WoRMS website (http://www.marinespecies.org/). It is important to take into account whether or not a species name has been "accepted" by WoRMS or not, and, should this not be the case, what is the correct name and species identifier.

``` {r trawl_occ}
trawl_sp_wrangle <- trawl %>%
  mutate(Species = paste(FISH1, FISH2, sep = " ")) %>% 
  # For each trawl, note for each of these species whether it was present or absent:
  complete(NUMBER, Species, fill = list(MASSCATCH = 0)) %>%
  group_by(NUMBER) %>% 
  fill(trawl, .direction = "downup") %>% 
  ungroup(NUMBER) %>% 
  # Add present or absent depending on whether "MASSCATCH > 0"
  # We decided to determine occurrenceStatus on MASSCATCH rather than PIECES because some species were caught (had a MASSCATCH rec.) but were not recorded under PIECES. This was mostly the case for jellyfish spp., and perhaps it was difficult to enumerate number of individuals.
  mutate(occurrenceStatus = ifelse(MASSCATCH > 0, "present", "absent")) %>% 
  rename(eventID = trawl,
         scientificName = Species) %>%
  select(eventID, scientificName, occurrenceStatus, Group) %>%
  # Filter only for present species, with the exception of the 5 Pacific salmon species
  filter(scientificName %in% c("Oncorhynchus gorbuscha",
                               "Oncorhynchus keta",
                               "Oncorhynchus kisutch",
                               "Oncorhynchus nerka",
                               "Oncorhynchus tschawytscha") |
           occurrenceStatus == "present") %>% 
  mutate(
    occurrenceID = paste("IYS_GoA2019_occ", row_number(),sep = ""),
    scientificNameID = case_when(
      scientificName == "Abraliopsis felis" ~ "urn:lsid:marinespecies.org:taxname:341849",
      scientificName == "Aequorea sp." ~ "urn:lsid:marinespecies.org:taxname:116998",
      scientificName == "Anotopterus nikparini" ~ "urn:lsid:marinespecies.org:taxname:272040",
      scientificName == "Aptocyclus ventricosus" ~ "urn:lsid:marinespecies.org:taxname:254299",
      scientificName == "Aurelia labiata" ~ "urn:lsid:marinespecies.org:taxname:287213",
      scientificName == "Aurelia limbata" ~ "urn:lsid:marinespecies.org:taxname:158199",
      scientificName == "Belonella borealis" ~ "urn:lsid:marinespecies.org:taxname:410406",
      scientificName == "Boreoteuthis borealis" ~ "urn:lsid:marinespecies.org:taxname:342326",
      # Different genus name to what was provided: Gonatopsis vs. Boreoteuthis
      scientificName == "Calycopsis sp." ~ "urn:lsid:marinespecies.org:taxname:117028",
      scientificName == "Chiroteuthis calyx" ~ "urn:lsid:marinespecies.org:taxname:341796",
      scientificName == "Chrysaora melonaster" ~ "urn:lsid:marinespecies.org:taxname:287209",
      # Slightly different spelling of species name
      scientificName == "Corolla calceola" ~ "urn:lsid:marinespecies.org:taxname:532663",
      scientificName == "Diaphus theta" ~ "urn:lsid:marinespecies.org:taxname:272694",
      scientificName == "Gasterosteus aculeatus" ~ "urn:lsid:marinespecies.org:taxname:126505",
      scientificName == "Gonatidae sp." ~ "urn:lsid:marinespecies.org:taxname:11743",
      scientificName == "Gonatus madokai" ~ "urn:lsid:marinespecies.org:taxname:341858",
      scientificName == "Gonatus onyx" ~ "urn:lsid:marinespecies.org:taxname:341859",
      scientificName == "Gonatus sp." ~ "urn:lsid:marinespecies.org:taxname:138036",
      scientificName == "Hormiphora cucumis" ~ "urn:lsid:marinespecies.org:taxname:106382",
      scientificName == "Icichthys lockingtoni" ~ "urn:lsid:marinespecies.org:taxname:279354",
      scientificName == "Japetella diaphana" ~ "urn:lsid:marinespecies.org:taxname:138849",
      scientificName == "Lestidium ringens" ~ "urn:lsid:marinespecies.org:taxname:272096",
      # slightly different accepted name than what was recorded
      scientificName == "Lipolagus ochotensis" ~ "urn:lsid:marinespecies.org:taxname:281374",
      scientificName == "Microstomus pacificus" ~ "urn:lsid:marinespecies.org:taxname:274294",
      scientificName == "Moroteuthis robusta" ~ "urn:lsid:marinespecies.org:taxname:410385",
      # different genus name than what was recorded
      scientificName == "Oncorhynchus gorbuscha" ~ "urn:lsid:marinespecies.org:taxname:127182",
      scientificName == "Oncorhynchus keta" ~ "urn:lsid:marinespecies.org:taxname:127183",
      scientificName == "Oncorhynchus kisutch" ~ "urn:lsid:marinespecies.org:taxname:127184",
      scientificName == "Oncorhynchus nerka" ~ "urn:lsid:marinespecies.org:taxname:254569",
      scientificName == "Oncorhynchus tschawytscha" ~ "urn:lsid:marinespecies.org:taxname:158075",
      scientificName == "Onychoteuthis borealijaponica" ~ "urn:lsid:marinespecies.org:taxname:342069",
      scientificName == "Paralepididae gen. sp." ~ "urn:lsid:marinespecies.org:taxname:125447",
      scientificName == "Periphylla periphylla" ~ "urn:lsid:marinespecies.org:taxname:135294",
      scientificName == "Phacellophora camtshchatica" ~ "urn:lsid:marinespecies.org:taxname:135309",
      # Slightly different spelling
      scientificName == "Salpa sp." ~ "urn:lsid:marinespecies.org:taxname:137233",
      scientificName == "Sebastes melanops" ~ "urn:lsid:marinespecies.org:taxname:274817",
      scientificName == "Sergestes similis" ~ "urn:lsid:marinespecies.org:taxname:514127",
      # Different accepted genus name
      scientificName == "Siphonophora sp." ~ "urn:lsid:marinespecies.org:taxname:1371",
      scientificName == "Squalus acanthias" ~ "urn:lsid:marinespecies.org:taxname:105923",
      scientificName == "Stenobrachius leucopsarus" ~ "urn:lsid:marinespecies.org:taxname:254363",
      scientificName == "Symbolophorus californiense" ~ "urn:lsid:marinespecies.org:taxname:272733",
      # Slightly different species name spelling
      scientificName == "Tarletonbeania crenularis" ~ "urn:lsid:marinespecies.org:taxname:282927",
      scientificName == "Thalassenchelys coheni" ~ "urn:lsid:marinespecies.org:taxname:282952",
      scientificName == "Thetys vagina" ~ "urn:lsid:marinespecies.org:taxname:137281",
      scientificName == "Thysanoessa spinifera" ~ "urn:lsid:marinespecies.org:taxname:237874",
      scientificName == "Zaprora silenus" ~ "urn:lsid:marinespecies.org:taxname:254353"
      )
    )

# We will create a separate data frame for the proper occurrence table. The `trawl_sp_wrangle` data frame will be used in the next chunk to create the extended MeasurementOrFact extension.
trawl_occ <- trawl_sp_wrangle %>% 
  select(eventID, occurrenceID, scientificName, scientificNameID, occurrenceStatus) %>% 
  mutate(basisOfRecord = "HumanObservation")
```

_The chunk of code below is only required if we work with a complete table of present/absent species at each station!_ We can do a quick check to make sure that all the unique species are included in the trawl_occ dataframe, at each station (`eventID`)! We need to make sure that the output is TRUE. If confirmed, the Occurrence table can be saved locally and in the correct Google Drive folder. 

``` {r trawl_occ_check}
check_spp <- trawl_occ %>% group_by(eventID) %>%
  summarise(count = n_distinct(scientificNameID)) 

unique_spp <- unique(trawl_sp_wrangle$scientificName)
length(unique_spp)

if(check_spp$count[]i == length(unique_spp)) {
    print("TRUE")
  } else {
    print("FALSE")
  }
```

``` {r save_data, eval = FALSE}
write_csv(trawl_occ, here("Trawl", "tidy_data", "trawl_occ.csv"))
drive_upload(here("Trawl", "tidy_data", "trawl_occ.csv"),
             path = "https://drive.google.com/drive/folders/1MQ6XJQqnWk2puDaBTfHn7wXITjDSeLR7",
             name = "trawl_occ.csv",
             overwrite = TRUE)
```


## Extended MeasurementOrFact Extension

Although there exist Darwin Core terms related to class _Occurrence_ such as individualCount, organismQuantity, lifeStage, etc., OBIS recommends adding all measurements to the eMoF extension (De Pooter et al. 2007). There are three benefits of storing measurements in the eMoF extension instead of in the Occurrence core:

1. Individual counts and derived quantifications (abundance or biomass) can be captured without needing to create duplicate occurrence records
2. The measurementTypeID field enables reference to external controlled vocabularies (e.g. NERC server), rather than maintaining a vocabulary within OBIS, and
3. Allows an unlimited number of measurement parameters to be stored without altering table structure

From the Occurrence table, we filter for occurrenceStatus == "present", as these have the unique occurrenceIDs that have measurements associated to them. Next, we have to merge it with the trawl df, as that's where the measurements are stored. To merge these dataframes, we rename a few columns in the trawl df so we can merge by specific columns.

```{r eMoF}
trawl_emof_wrangle <- trawl_sp_wrangle %>% 
  filter(occurrenceStatus == "present")
  # Rename trawl column in dataframe `trawl` to `eventID` and use merge()
  # measurements are found in the trawl dataframe, so we need to transform that
  # dataframe slightly and merge it with the newly created trawl_emof:
trawl <- trawl %>% mutate(Species = paste(FISH1, FISH2, sep = " ")) %>%
  dplyr::rename(scientificName = Species,
                eventID = trawl)
trawl_emof <- merge(trawl_emof_wrangle, trawl, by = c("eventID", "scientificName", "Group")) %>%
  # We have to merge by Group as well because otherwise similar occIDs will be created for different lifestages within a single trawl set (i.e., if both adult and juvenile Chinook salmon are caught these will be given the same occID if it's only done by scientificName).
  mutate(LMIN = format(LMIN, digits = 2),
         LMAX = format(LMAX, digits = 2),
         MASSCATCH = format(MASSCATCH, digits = 4)
         ) %>% mutate_all(as.character) %>%
  pivot_longer(cols = c("Group","LMIN","LMAX","PIECES","MASSCATCH"),
               names_to = "measurementType", values_to = "measurementValue") %>% 
  mutate(measurementType = recode(measurementType,
                                  "Group" = "age class",
                                  "LMIN" = "minimum length",
                                  "LMAX" = "maximum length",
                                  "PIECES" = "number of individuals",
                                  "MASSCATCH" = "catch biomass"
                                  ),
         measurementTypeID = case_when(
           measurementType == "minimum length" ~ "http://vocab.nerc.ac.uk/collection/P01/current/OBSMINLX/",
           measurementType == "maximum length" ~ "http://vocab.nerc.ac.uk/collection/P01/current/OBSMAXLX/",
           measurementType == "number of individuals" ~ "http://vocab.nerc.ac.uk/collection/S06/current/S0600008/",
           measurementType == "catch biomass" ~ "http://vocab.nerc.ac.uk/collection/S06/current/S0600088/"
           ),
         measurementValue = recode(measurementValue,
                                   "(juv.)" = "juvenile",
                                   "(immature)" = "immature",
                                   "(mature)" = "mature"
                                   ),
         measurementValueID = case_when(
           measurementValue == "juvenile" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1127/",
           measurementValue == "immature" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1171/",
           measurementValue == "mature" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1116/"
           ),
         measurementUnit = case_when(
           measurementType == "number of individuals" ~ "individuals",
           measurementType == "minimum length" ~ "cm",
           measurementType == "maximum length" ~ "cm",
           measurementType == "catch biomass" ~ "kg"
           ),
         measurementUnitID = case_when(
           measurementUnit == "individuals" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UUUU/",
           measurementUnit == "cm" ~ "http://vocab.nerc.ac.uk/collection/P06/current/ULCM/",
           measurementUnit == "kg" ~ "http://vocab.nerc.ac.uk/collection/P06/current/KGXX/"
         )
  ) %>% 
  select(eventID, 
         occurrenceID, 
         measurementType, 
         measurementTypeID, 
         measurementValue, 
         measurementValueID,
         measurementUnit,
         measurementUnitID) %>% 
  drop_na(measurementValue)

write_csv(trawl_emof, here("Trawl", "tidy_data", "trawl_eMoF.csv"))
drive_upload(here("Trawl", "tidy_data", "trawl_emof.csv"),
             path = "https://drive.google.com/drive/folders/1MQ6XJQqnWk2puDaBTfHn7wXITjDSeLR7",
             name = "trawl_eMoF.csv",
             overwrite = TRUE)
```


