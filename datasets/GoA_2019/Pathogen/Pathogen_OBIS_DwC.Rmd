---
title: "Pathogen Data wrangle"
author: "Tim van der Stap"
date: "8/26/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(readxl)
library(here)
library(parsedate)
library(googledrive)
```

## Getting started

The following line only needs to be run once to download the required data sheets from Google Drive to your computer's hard drive.

```{r drive_download}
# Make sure your folder path exists already (e.g. ./Pathogen/raw_data)
drive_download("https://docs.google.com/spreadsheets/d/1C0SQXMguIWBCRWQZcStE0nz4LLPd5ljUlqZsvhli6x0/edit#gid=2047605249",                path = here("Pathogen", "raw_data", "Pathogens_IYS_GoA_2019.xlsx"), overwrite = TRUE)

drive_download("https://docs.google.com/spreadsheets/d/1kOtcCcvjk7N2pAuJNKZjvhR35v209kVrZTTgsx-aWQw/edit#gid=929610966",
               path = here("Pathogen", "raw_data", "Pathogen_info.xlsx"), overwrite = TRUE)

drive_download("https://docs.google.com/spreadsheets/d/1mhvdnETRNwaDEgvRoxYl8HKLuvqjCOLHJsiKZqNCr_4/edit#gid=925605785",
               path = here("Pathogen", "raw_data", "Sample_info_IYS_GoA_2019_Fish_Health.xlsx"), overwrite = TRUE)
```

No metadata is mentioned in the Pathogen data as to when and where the salmon were caught (i.e. when trawls took place). To connect the coordinates and time to the eventIDs, this information is taken from the trawl datasheet. Right now I am saving both these files in the Pathogen folder, but once all folders and scripts have been QC'd the location/time can be read straight from the Trawl-specific folder. For now, I'm afraid it would cause confusion when committing/pushing to GitHub. 

``` {r salmon_datetime, eval = FALSE}
drive_download(file = "https://docs.google.com/spreadsheets/d/1rtT6L5WSi_UiiXfoS95wnDqA8loc959T/edit#gid=668595086", 
               path = here::here("Pathogen", "raw_data", 
                                 "2019_GoA_Fish_data_Hakai.xlsx"),
               overwrite = TRUE)

trawl <- read_excel(here("Pathogen", "raw_data", "2019_GoA_Fish_data_Hakai.xlsx")) %>%
  mutate(eventDate = format_iso_8601(as.POSIXct(UTC_start)),
         eventDate = str_replace(eventDate, "\\+00:00", "Z")) %>%
  mutate(station = paste("GoA2019", NUMBER, sep = "_Stn"))
```

**Please note that the date and coordinates could change as the trawl data is not finalized.** 

Read in the dataset from your local drive, and combine the data into one dataframe. The data file `Pathogen_info.xlsx` expands on the abbreviations used in the pathogen data file, and will be joined in at a later stage.  

``` {r data wrangle, eval = FALSE}
pathogen_names <- read_excel(here("Pathogen", "raw_data", 
                       "Pathogen_info.xlsx"))
pathogen_floytag <- read_excel(here("Pathogen", "raw_data",
                                    "Sample_info_IYS_GoA_2019_Fish_Health.xlsx"))
pathogen_data <- read_excel(here("Pathogen", "raw_data",
                                 "Pathogens_IYS_GoA_2019.xlsx"))

pathogen <- left_join(pathogen_floytag, pathogen_data, by = "Sample") %>%
  mutate(project = "IYS",
         cruise = paste(project, "GoA2019", sep = ":"),
         station = paste(cruise, Set, sep = "_Stn"),
         trawl = paste(station, "trawl1", sep = ":")
  )

# Download and read in metadata pertaining to the trawl, and select relevant columns (i.e. floytag, coordinates, date, time, sampling depth, etc)
```

## Create the Event core

In the Event Core we include the different metadata information pertaining to the various levels. As no metadata pertaining to the date, time and coordinates of the trawl are included in the pathogen data, we need to include this information from the general trawl data and match by Sample. 

``` {r pathogen_event, eval = FALSE}
pathogen_project <- pathogen %>%
  select(eventID = project) %>%
  distinct(eventID)

pathogen_cruise <- pathogen %>% 
  select(eventID = cruise,
         parentEventID = project) %>%
  distinct(eventID, .keep_all = TRUE)

pathogen_station <- pathogen %>%
  select(eventID = station,
         parentEventID = cruise) %>% 
  distinct(eventID, .keep_all = TRUE) 

# Join date and coordinates to trawl. Remember that the date and coordinates are not from the Pathogen data sheet, but from the trawl data sheet. Minimum and maximum depth of the trawl be included here as well if the information becomes available. 
pathogen_trawl <- salmon %>%
  left_join(select(
    trawl,
    station,
    UTC_start,
    X,
    Y
  )) %>%
  select(eventID = trawl,
         parentEventID = station,
         eventDate = UTC_start,
         decimalLatitude = Y,
         decimalLongitude = X) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate(eventRemarks = "trawl")

# The Pathogen data does not include information as to at what depths the trawls were conducted. This information will have to come from the general Trawl data. Should this information become available it should be connected to the general trawl information, along with info such as: speed at which the vessel was traveling during trawl, starting & finish lat/longs of trawl.

pathogen_sample <- pathogen %>% 
  select(eventID = sample,
         parentEventID = trawl) %>% 
  distinct(eventID, .keep_all = TRUE) %>% 
  mutate(eventRemarks = "sample")

# To connect them all together: 
pathogen_event <- bind_rows(pathogen_cruise,
                            pathogen_station,
                            pathogen_trawl, 
                            pathogen_sample) %>%
  select(eventID, parentEventID:decimalLongitude, eventRemarks) %>%
  mutate(type = "PreservedSpecimen")

# Make sure the folder path exists already (e.g. ./Salmon Diet/tidy_data)
write_csv(salmon_event, here("Pathogen", "tidy_data", "pathogen_event.csv"))
drive_upload(here("Pathogen", "tidy_data", "pathogen_event.csv"),
             path = " ",
             name = "pathogen_event.csv",
             overwrite = TRUE)
```

## Occurrence Core

We will combine two occurrence tables into a single Occurrence Core. In this Occurrence Core, there will be a column `associatedTaxa` that will link the pathogens data (relative Ct-values) to the respective salmon species (individual). The first occurrence table will identify which species of salmon is associated to Sample. This information is taken from the dataframe `pathogen_floytag`. The second occurrence table will list all the pathogens identified and measured. 

``` {r occ, eval = FALSE}
pathogen_salmon_spp <- pathogen %>% mutate(Species = case_when(
    Species == "Coho" ~ "Oncorhynchus kisutch",
    Species == "Pink" ~ "Oncorhynchus gorbuscha",
    Species == "Chum" ~ "Oncorhynchus keta",
    Species == "Chinook" ~ "Oncorhynchus tshawytscha",
    Species == "Sockeye" ~ "Oncorhynchus nerka"
  )) %>%
  rename(scientificName = Species) %>% 
  mutate(occurrenceStatus = "present",
         occurrenceID = paste(trawl, Sample, sep = ":"),
         scientificNameID = case_when(
scientificName == "Oncorhynchus gorbuscha" ~ "urn:lsid:marinespecies.org:taxname:127182",
scientificName == "Oncorhynchus kisutch" ~ "urn:lsid:marinespecies.org:taxname:127184",
scientificName == "Oncorhynchus keta" ~ "urn:lsid:marinespecies.org:taxname:127183",
scientificName == "Oncorhynchus nerka" ~ "urn:lsid:marinespecies.org:taxname:254569",
scientificName == "Oncorhynchus tshawytscha" ~ "urn:lsid:marinespecies.org:taxname:158075")) %>%
  rename(eventID = trawl)

pathogen_salmon_spp <- pathogen_salmon_spp %>%
  select(eventID, occurrenceID, scientificName, scientificNameID, occurrenceStatus)
```

Now that we've created the first occurrence table, we create the second one, where the pathogens get assigned a unique identifier (i.e. a WoRMS URN) in the scientificNameID and a unique occurrenceID. Using the column `associatedTaxa`, the pathogens will eventually be linked to the correct salmon individual. For the pathogen data, the first step is to select the correct columns from the Pathogen data file, and expand on the abbreviations. 

``` {r occ_pathogens, eval = FALSE}
pathogen_occ <- pathogen %>% 
  select(trawl,
         Sample,
         ae_sal:ye_ruc_glnA) %>%
  pivot_longer(cols = ae_sal:ye_ruc_glnA,
               names_to = "Assay name")

pathogen_occ <- left_join(pathogen_occ, pathogen_names, by = "Assay name") 

# A list of the unique pathogens (viruses, bacteria, parasites) can be found using:
unique_pathogens <- unique(pathogen_occ$Name)

# I've requested new WoRMS entries for some bacteria, viruses and parasites that were not currently found in WoRMS. It is likely that the scientificNameIDs will have to be populated manually once these new taxa have been created in the registry.  
  rename(scientificName = Name,
         eventID = trawl) %>%
  mutate(occurrenceID = paste(eventID, Sample, sep = ":"),
         occurrenceStatus = "present")
```

``` {r save_occ, eval = FALSE}
# Make sure the folder path exists already (e.g. ./Salmon Diet/tidy_data)
write_csv(pathogen_spp_occ, here("Pathogen", "tidy_data", "pathogen_spp_occ.csv"))
drive_upload(here("Pathogen", "tidy_data", "pathogen_spp_occ.csv"),
             path = " ",
             name = "pathogen_spp_occ.csv",
             overwrite = TRUE)
```

The second Occurrence Core reflects the presence or absence of certain pathogens on each salmon individual. In the current state of the file, pathogen presence or absence is reflected by either a + (present) or - (absent). Please note that any additional columns, such as `sea lice`, `stock` and `sticky_gut` are not included in the Occurrence and eMOF Cores because they are not the focus of this study. 

``` {r, eval = FALSE}
pathogen_occ <- pathogen %>%
  select(sample,
         aeromonas_salmonicida:piscine_orthoreovirus) %>%
  pivot_longer(cols = aeromonas_salmonicida:piscine_orthoreovirus,
               names_to = "scientificName",
               values_to = "measurementValue") %>%
  mutate(occurrenceID = paste(sample, "pocc", sep = ":"),
         occurrenceStatus = ifelse(measurementValue == "+", "present", "absent")) %>%
  rename(id = sample) %>%
  select(id, scientificName, measurementValue, occurrenceID, occurrenceStatus)

# Make sure the folder path exists already (e.g. ./Pathogen/tidy_data)
write_csv(pathogen_occ, here("Pathogen", "tidy_data" "pathogen_occ.csv"))
drive_upload(here("Pathogen", "tidy_data", "pathogen_occ.csv"),
             path = " ",
             name = "pathogen_occ.csv",
             overwrite = TRUE)
```

## Measurement Or Fact Core

Next we need to associate the measurements of `fork length`, `mass` and `sex` to these salmon. Although it is not the focus of this study, perhaps we also have to include measurements regarding `adc`, `cwt`, `black_spots` etc here?

``` {r eMOF, eval = FALSE}
pathogen_spp_measurement <- pathogen %>%
  select(measurementID = sample,
         fl:sex) %>%
  select(-k) %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = fl:sex, 
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementID = paste(measurementID, measurementType, sep = ":"),
    measurementTypeID = case_when(
    measurementType == "fl" ~ " ",
    # But standard length: 	http://vocab.nerc.ac.uk/collection/P01/current/SL01XX01/
    measurementType == "mass" ~ "http://vocab.nerc.ac.uk/collection/P24/current/NMASS/",
    measurementType == "sex" ~ " "),
         measurementUnit = case_when(
    measurementType == "fl" ~ "cm",
    measurementType == "mass" ~ "g",
    measurementType == "sex" ~ " "),
         measurementUnitID = case_when(
    measurementUnit == "cm" ~ "http://vocab.nerc.ac.uk/collection/P06/current/ULCM/",
    measurementUnit == "g" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UGRM/",
    measurementUnit == " " ~ "http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"),
         measurementValueID = case_when(
    measurementValue == "F" ~ "http://vocab.nerc.ac.uk/collection/S10/current/S102/",
    measurementValue == "M" ~ "http://vocab.nerc.ac.uk/collection/S10/current/S103/"
         )) %>%
  select(measurementID, measurementType, measurementTypeID,
         measurementValue, measurementValueID, measurementUnit, measurementUnitID)
  
# Write up csv file and upload to Google Drive folder
write_csv(pathogen_spp_measurement, here("Pathogen", "tidy_data", "pathogen_spp_measurement.csv"))
drive_upload(here("Pathogen", "tidy_data", "pathogen_spp_measurement.csv"),
             path = " ",
             name = "pathogen_spp_eMoF.csv",
             overwrite = TRUE)
```
