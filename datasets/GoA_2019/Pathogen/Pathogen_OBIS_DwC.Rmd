---
title: "Pathogen Data wrangle"
author: "Tim van der Stap"
date: "8/26/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(readxl)
library(here)
library(parsedate)
library(googledrive)
```

## Getting started

The following line only needs to be run once to download the tidied data from Google Drive to your computer's hard drive

```{r drive_download}
# Make sure your folder path exists already (e.g. ./POM/raw_data)
drive_download("https://docs.google.com/spreadsheets/d/14YOHGGrU0zi--QHurgC6YVqlJ2GMPdoa/edit#gid=1919082779", 
               path = here("Pathogen", "raw_data", "IYS_GoA_2019_fish_health_pathogen_detections.xlsx"),
               overwrite = TRUE)
```

No metadata is mentioned in the Pathogen data as to when and where the salmon were caught (i.e. when trawls took place). To connect the coordinates and time to the eventIDs, this information is taken from the trawl datasheet. Right now I am saving both these files in the Pathogen folder, but once all folders and scripts have been QC'd the location/time can be read straight from the Trawl-specific folder. For now, I'm afraid it would cause confusion when committing/pushing to GitHub. 

``` {r salmon_datetime, eval = FALSE}
drive_download(file = "https://docs.google.com/spreadsheets/d/1rtT6L5WSi_UiiXfoS95wnDqA8loc959T/edit#gid=668595086", 
               path = here::here("Pathogen", "raw_data", 
                                 "2019_GoA_Fish_data_Hakai.xlsx"),
               overwrite = TRUE)

trawl <- read_excel(here("Pathogen", "raw_data", "2019_GoA_Fish_data_Hakai.xlsx")) %>%
  mutate(eventDate = format_iso_8601(as.POSIXct(UTC_start)),
         eventDate = str_replace(eventDate, "\\+00:00", "Z")) %>%
  mutate(station = paste("GoA2019", NUMBER, sep = "_Stn"))
```

**Please note that the date and coordinates could change as the trawl data is not finalized.** 

Read in the dataset from your local drive:

``` {r data wrangle, eval = FALSE}
pathogen <- read_excel(here("Pathogen", "raw_data", 
                       "IYS_GoA_2019_fish_health_pathogen_detections.xlsx"), 
                  sheet = "Sheet1") %>%
  janitor::clean_names() %>%
  # Convert the standalone time value (UTC+12) into ISO8601 extended format
  mutate(cruise = "GoA2019",
         station = paste(cruise, set, sep="_Stn"),
         trawl = paste(station, "trawl1", sep = ":"),
         sample = paste(trawl, mgl_number, sep=":")
  )
```

## Create the Event core

To help distinguish the different hierarchical event levels, we use the column `eventRemarks`. The column `type` is is a Record-class term to describe the nature of the data resoure, but is not required by OBIS.

``` {r salmondiet_event, eval = FALSE}
pathogen_cruise <- pathogen %>% 
  select(eventID = cruise) %>%
  distinct(eventID) %>%
  mutate(eventRemarks = "cruise")

pathogen_station <- pathogen %>%
  select(eventID = station,
         parentEventID = cruise) %>% 
  distinct(eventID, .keep_all = TRUE) %>% 
  mutate(eventRemarks = "station")

# Join date and coordinates to trawl. Remember that the date and coordinates are not from the Pathogen data sheet, but from the trawl data sheet. Minimum and maximum depth of the trawl be included here as well if the information becomes available. 
pathogen_trawl <- salmon %>%
  left_join(select(
    trawl,
    station,
    UTC_start,
    X,
    Y
  )) %>%
  select(eventID = trawl,
         parentEventID = station,
         eventDate = UTC_start,
         decimalLatitude = Y,
         decimalLongitude = X) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate(eventRemarks = "trawl")

# The Pathogen data does not include information as to at what depths the trawls were conducted. This information will have to come from the general Trawl data. Should this information become available it should be connected to the general trawl information, along with info such as: speed at which the vessel was traveling during trawl, starting & finish lat/longs of trawl.

pathogen_sample <- pathogen %>% 
  select(eventID = sample,
         parentEventID = trawl) %>% 
  distinct(eventID, .keep_all = TRUE) %>% 
  mutate(eventRemarks = "sample")

# To connect them all together: 
pathogen_event <- bind_rows(pathogen_cruise,
                            pathogen_station,
                            pathogen_trawl, 
                            pathogen_sample) %>%
  select(eventID, parentEventID:decimalLongitude, eventRemarks) %>%
  mutate(type = "HumanObservation")

# Make sure the folder path exists already (e.g. ./Salmon Diet/tidy_data)
write_csv(salmon_event, here("Pathogen", "tidy_data", "pathogen_event.csv"))
drive_upload(here("Pathogen", "tidy_data", "pathogen_event.csv"),
             path = " ",
             name = "pathogen_event.csv",
             overwrite = TRUE)
```

## Occurrence Core

The first Occurrence Core will identify which species of salmon is associated to the mgl_number. That occurrence will then have the associated measurements of `fork length`, `mass` and `sex`. If there is also an interest in understanding what salmon species were not caught / floytagged at a station, we need to use `complete()` to fill in the rest of the species.

``` {r occ, eval = FALSE}
pathogen <- pathogen %>%  mutate(species = case_when(
    species == "Coho" ~ "Oncorhynchus kisutch",
    species == "Pink" ~ "Oncorhynchus gorbuscha",
    species == "Chum" ~ "Oncorhynchus keta",
    species == "Chinook" ~ "Oncorhynchus tschawytschka",
    species == "Sockeye" ~ "Oncorhynchus nerka"
  ))

pathogen_spp_occ <- pathogen %>%
  rename(scientificName = species) %>% 
  mutate(occurrenceStatus = "present",
         occurrenceID = paste(trawl, scientificName, sep = ":"),
         scientificNameID = case_when(
scientificName == "Oncorhynchus gorbuscha" ~ "urn:lsid:marinespecies.org:taxname:127182",
scientificName == "Oncorhynchus kisutch" ~ "urn:lsid:marinespecies.org:taxname:127184",
scientificName == "Oncorhynchus keta" ~ "urn:lsid:marinespecies.org:taxname:127183",
scientificName == "Oncorhynchus nerka" ~ "urn:lsid:marinespecies.org:taxname:254569",
scientificName == "Oncorhynchus tschawytscha" ~ "urn:lsid:marinespecies.org:taxname:158075")) %>%
  # Accepted name has slightly different species name: O. tshawytscha
  rename(eventID = trawl) %>%
  select(eventID, occurrenceID, scientificName, scientificNameID, occurrenceStatus)

# Make sure the folder path exists already (e.g. ./Salmon Diet/tidy_data)
write_csv(pathogen_spp_occ, here("Pathogen", "tidy_data", "pathogen_spp_occ.csv"))
drive_upload(here("Pathogen", "tidy_data", "pathogen_spp_occ.csv"),
             path = " ",
             name = "pathogen_spp_occ.csv",
             overwrite = TRUE)
```

## Measurement Or Fact Core

Next we need to associate the measurements of `fork length`, `mass` and `sex` to these salmon:

``` {r eMOF, eval = FALSE}
pathogen_spp_measurement <- pathogen %>%
  select(measurementID = sample,
         fl:sex) %>%
  select(-k) %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = fl:sex, 
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementID = paste(measurementID, measurementType, sep = ":"),
    measurementTypeID = case_when(
    measurementType == "fl" ~ " ",
    # But standard length: 	http://vocab.nerc.ac.uk/collection/P01/current/SL01XX01/
    measurementType == "mass" ~ "http://vocab.nerc.ac.uk/collection/P24/current/NMASS/",
    measurementType == "sex" ~ " "),
         measurementUnit = case_when(
    measurementType == "fl" ~ "cm",
    measurementType == "mass" ~ "g",
    measurementType == "sex" ~ " "),
         measurementUnitID = case_when(
    measurementUnit == "cm" ~ "http://vocab.nerc.ac.uk/collection/P06/current/ULCM/",
    measurementUnit == "g" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UGRM/",
    measurementUnit == " " ~ "http://vocab.nerc.ac.uk/collection/P06/current/UUUU/")) %>%
  select(measurementID, measurementType, measurementTypeID,
         measurementValue, measurementUnit, measurementUnitID)
  
# Write up csv file and upload to Google Drive folder
write_csv(salmon_spp_measurement, here("Salmon Diet", "tidy_data", "salmon_spp_measurement.csv"))
drive_upload(here("Salmon Diet", "tidy_data", "salmon_spp_measurement.csv"),
             path = "https://drive.google.com/drive/u/0/folders/1pGd2cuvdb25QX7CGm2wC81Emh5O-LdbR",
             name = "salmon_spp_eMoF.csv",
             overwrite = TRUE)
```
