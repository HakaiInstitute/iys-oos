---
title: "NPMSDD_OBIS"
author: "Tim van der Stap"
date: "10/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

ipak <- function(pkg){
    new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
    if (length(new.pkg)) 
        install.packages(new.pkg, dependencies = TRUE)
    sapply(pkg, require, character.only = TRUE)
}

packages <- c("tidyverse", "lubridate", "devtools", "obistools", "readxl", "parsedate", "googledrive", "here")
ipak(packages) 
```

For the NPMSDD it was opted to create an Occurrence Core, rather than an Event Core with an associated Occurrence Core. The reason for this is that most data sources in the database consisted of aggregated data, with a lot of heterogeneity within geo-spatial scale. Therefore, if only a single time and spatial frame was associated with each source, the granularity would be very low and potentially important information would be lost. Therefore, it was opted to create an Occurrence Core, and associate date, time and spatial coordinates to each occurrenceID (i.e., the capture of a salmon or identification of prey from stomach content). This way, all the geo-spatio information for each capture and identification can be recorded and no information is lost due from aggregation. 

``` {r NPMSDD_Occ, eval = FALSE}
npmsdd <- read_csv(here::here("datasets", "npmsdd_data_from_caroline", "diet_final.csv"))
npmsdd <- npmsdd %>% select(source_id, lat_min, lat_max, lon_min, lon_max, year_min, year_max, 
                            warm_cool_years, odd_even_years, season_min, season_max,
                            month_min, month_max, date_min, time_min, time_max, predator_id,
                            prey_lowest_taxonomic_level, prey_kingdom, prey_phylum, prey_class, 
                            prey_order, prey_family, prey_genus, prey_species,
                            gear_type_predator_id1, gear_type_predator_id2, gear_type_predator_id3,
                            gear_type_predator_id4, gear_type_predator_id5)

#importing predator (salmon) and prey biological data
pred_bio <- read_csv("predator_biological_data.csv", col_types = "iiiiccccccccttnnnncccciiiiiicccnnnnnnicciciiiiiccnnnnnc") %>% 
  select(predator_id, predator_lowest_taxonomic_level) %>%
  distinct()

prey_bio <- prey_bio <- read_csv("prey_biological_data.csv", col_types = "iiiiiccccccccttnnnncccciiiiiicccnnnnnnicciciiiiicccccccccccnnnnnnciiciiiiiccnnnnnc") %>%
  select(prey_id, predator_id) 

# Join dataframes and select only for those data entries where prey has been identified (i.e. there is at least a value recorded in prey_kingdom), and where this prey can be linked to predator. 
NPMSDD_occ <- left_join(npmsdd, pred_bio, by = "predator_id") %>%
  filter(!is.na(predator_lowest_taxonomic_level)) %>%
  filter(!is.na(prey_kingdom)) %>% dplyr::rename(eventID = source_id) %>%
  mutate(eventID = paste("NPMSDD_sourceID", eventID, sep = ":"),
         eventID = paste(eventID, predator_id, sep = ":predID"),
         occurrenceStatus = "present",
         occurrenceID = paste(eventID, prey_lowest_taxonomic_level, sep = ":"),
         occurrenceID = paste(occurrenceID, "pr", sep = "-")) %>%
  dplyr::rename(scientificName = prey_lowest_taxonomic_level) %>% 
  mutate(scientificNameID = case_when(
    scientificName == "Actinopterygii" ~ "urn:lsid:marinespecies.org:taxname:10194",
    scientificName == "Brachyura" ~ "urn:lsid:marinespecies.org:taxname:106673",
    scientificName == "Copepoda" ~ "urn:lsid:marinespecies.org:taxname:1080",
    scientificName == "Euphausiacea" ~ "urn:lsid:marinespecies.org:taxname:1128",
    scientificName == "Hyperiidae" ~ "urn:lsid:marinespecies.org:taxname:101417",
    scientificName == "Limacina" ~ "urn:lsid:marinespecies.org:taxname:138122",
    scientificName == "Sagitta" ~ "urn:lsid:marinespecies.org:taxname:105410",
    scientificName == "Oikopleura" ~ "urn:lsid:marinespecies.org:taxname:103367",
    scientificName == "Coleoidea" ~ "urn:lsid:marinespecies.org:taxname:11709",
    scientificName == "Berryteuthis magister" ~ "urn:lsid:marinespecies.org:taxname:342286",
    scientificName == "Engraulis japonicus" ~ "urn:lsid:marinespecies.org:taxname:219984",
    scientificName == "Euphausia pacifica" ~ "urn:lsid:marinespecies.org:taxname:237851",
    scientificName == "Gonatopsis borealis" ~ "urn:lsid:marinespecies.org:taxname:342326",
    scientificName == "Gonatus kamtschaticus" ~ "urn:lsid:marinespecies.org:taxname:341857",
    scientificName == "Hemilepidotus" ~ "urn:lsid:marinespecies.org:taxname:248338",
    scientificName == "Sardinops sagax" ~ "urn:lsid:marinespecies.org:taxname:217452",
    scientificName == "Thysanoessa longipes" ~ "urn:lsid:marinespecies.org:taxname:237873",
    scientificName == "Thysanoessa raschii" ~ "urn:lsid:marinespecies.org:taxname:110711",
    scientificName == "Ammodytes hexapterus" ~ "urn:lsid:marinespecies.org:taxname:254510",
    scientificName == "Clione limacina" ~ "urn:lsid:marinespecies.org:taxname:139178",
    scientificName == "Gadus chalcogrammus" ~ "urn:lsid:marinespecies.org:taxname:300735",
    scientificName == "Leuroglossus schmidti" ~ "urn:lsid:marinespecies.org:taxname:254551",
    scientificName == "Clupea pallasii" ~ "urn:lsid:marinespecies.org:taxname:151159",
    scientificName == "Mallotus villosus" ~ "urn:lsid:marinespecies.org:taxname:126735",
    scientificName == "Themisto" ~ "urn:lsid:marinespecies.org:taxname:101800",
    scientificName == "Cephalopoda" ~ "urn:lsid:marinespecies.org:taxname:11707",
    scientificName == "Hyperia galba" ~ "urn:lsid:marinespecies.org:taxname:103251",
    scientificName == "Pleurogrammus monopterigius" ~ "urn:lsid:marinespecies.org:taxname:282289",
    # Name: pleurogrammus monopterygius
    scientificName == "Themisto japonica" ~ "urn:lsid:marinespecies.org:taxname:744579",
    scientificName == "Neocalanus cristatus" ~ "urn:lsid:marinespecies.org:taxname:104470",
    scientificName == "Limacina helicina" ~ "urn:lsid:marinespecies.org:taxname:140223",
    scientificName == "Cololabis saira" ~ "urn:lsid:marinespecies.org:taxname:280366",
    scientificName == "Stenobrachius leucopsarus" ~ "urn:lsid:marinespecies.org:taxname:254363",
    scientificName == "Chionoecetes opilio" ~ "urn:lsid:marinespecies.org:taxname:107315",
    scientificName == "Eucalanus bungii" ~ "urn:lsid:marinespecies.org:taxname:196775",
    scientificName == "Oikopleura (Vexillaria) labradoriensis" ~ "urn:lsid:marinespecies.org:taxname:103413",
    scientificName == "Parasagitta elegans" ~ "urn:lsid:marinespecies.org:taxname:105440",
    scientificName == "Scopelosaurus harryi" ~ "urn:lsid:marinespecies.org:taxname:272082",
    scientificName == "Themisto pacifica" ~ "urn:lsid:marinespecies.org:taxname:254453",
    scientificName == "Thysanoessa inermis" ~ "urn:lsid:marinespecies.org:taxname:110708",
    scientificName == "Thysanoessa inspinata" ~ "urn:lsid:marinespecies.org:taxname:237872",
    scientificName == "Decapoda" ~ "urn:lsid:marinespecis.org:taxname:1130",
    scientificName == "Diaphus theta" ~ "urn:lsid:marinespecies.org:taxname:272694",
    scientificName == "Pagurus" ~ "urn:lsid:marinespecies.org:taxname:106854",
    scientificName == "Primno abyssalis" ~ "urn:lsid:marinespecies.org:taxname:421603",
    scientificName == "Stenobrachius nannochir" ~ "urn:lsid:marinespecies.org:taxname:254364",
    scientificName == "Neocalanus plumchrus" ~ "urn:lsid:marinespecies.org:taxname:196772",
    scientificName == "Polychaeta" ~ "urn:lsid:marinespecies.org:taxname:883",
    scientificName == "Aglantha digitale" ~ "urn:lsid:marinespecies.org:taxname:117849",
    scientificName == "Amphipoda" ~ "urn:lsid:marinespecies.org:taxname:1135",
    scientificName == "Anomura" ~ "urn:lsid:marinespecies.org:taxname:106671",
    scientificName == "Pandalus goniurus" ~ "urn:lsid:marinespecies.org:taxname:254483",
    scientificName == "Beroe cucumis" ~ "urn:lsid:marinespecies.org:taxname:106358", 
    scientificName == "Calanus glacialis" ~ "urn:lsid:marinespecies.org:taxname:104465",
    scientificName == "Primno macropa" ~ "urn:lsid:marinespecies.org:taxname:180759",
    scientificName == "Gonatopsis okutanii" ~ "urn:lsid:marinespecies.org:taxname:342330",
    scientificName == "Pleurogrammus" ~ "urn:lsid:marinespecies.org:taxname:270458",
    scientificName == "Myctophidae" ~ "urn:lsid:marinespecies.org:taxname:125498",
    scientificName == "Lumpenus" ~ "urn:lsid:marinespecies.org:taxname:126088",
    scientificName == "Pleuronectes" ~ "urn:lsid:marinespecies.org:taxname:126120",
    scientificName == "Ctenophora" ~ "urn:lsid:marinespecies.org:taxname:1248",
    scientificName == "Gonatus" ~ "urn:lsid:marinespecies.org:taxname:138036",
    scientificName == "Euphausiidae" ~ "urn:lsid:marinespecies.org:taxname:110671",
    scientificName == "Euphausia" ~ "urn:lsid:marinespecies.org:taxname:110673",
    scientificName == "Eumicrotremus" ~ "urn:lsid:marinespecies.org:taxname:126159",
    scientificName == "Gymnocanthus" ~ "urn:lsid:marinespecies.org:taxname:126149",
    scientificName == "Gonatopsis" ~ "urn:lsid:marinespecies.org:taxname:341428",
    scientificName == "Pleuronectidae" ~ "urn:lsid:marinespecies.org:taxname:125579",
    scientificName == "Themisto libellula" ~ "urn:lsid:marinespecies.org:taxname:156452",
    scientificName == "Todarodes pacificus" ~ "urn:lsid:marinespecies.org:taxname:342067",
    scientificName == "Thysanoessa" ~ "urn:lsid:marinespecies.org:taxname:110679",
    scientificName == "Watasenia scintillans" ~ "urn:lsid:marinespecies.org:taxname:342419",
    scientificName == "Siphonophorae" ~ "urn:lsid:marinespecies.org:taxname:1371",
    scientificName == "Pteropoda" ~ "urn:lsid:marinespecies.org:taxname:325345",
    scientificName == "Hexagrammidae" ~ "urn:lsid:marinespecies.org:taxname:154415",
    scientificName == "Hyperia medusarum" ~ "urn:lsid:marinespecies.org:taxname:103253",
    scientificName == "Rhynchonereella angelini" ~ "urn:lsid:marinespecies.org:taxname:416504",
    scientificName == "Arthropoda (terrestrial)" ~ "urn:lsid:marinespecies.org:taxname:1065",
    # WoRMS URN: Arthropoda
    scientificName == "Chaetognatha" ~ "urn:lsid:marinespecies.org:taxname:2081",
    scientificName == "Crustacea" ~ "urn:lsid:marinespecies.org:taxname:1066",
    scientificName == "Ammodytes" ~ "urn:lsid:marinespecies.org:taxname:125909",
    scientificName == "Insecta" ~ "urn:lsid:marinespecies.org:taxname:1307",
    scientificName == "Ostracoda" ~ "urn:lsid:marinespecies.org:taxname:1078",
    scientificName == "Calanoida" ~ "urn:lsid:marinespecies.org:taxname:1100",
    scientificName == "Gastropoda" ~ "urn:lsid:marinespecies.org:taxname:101",
    scientificName == "Calanus sinicus" ~ "urn:lsid:marinespecies.org:taxname:346214",
    scientificName == "Centropages abdominalis" ~ "urn:lsid:marinespecies.org:taxname:196774",
    scientificName == "Evadne normanni" ~ "urn:lsid:marinespecies.org:taxname:106273",
    # WoRMNS URN: Evadne nordmanni
    scientificName == "Gammaridae" ~ "urn:lsid:marinespecies.org:taxname:101383",
    scientificName == "Oikopleuridae" ~ "urn:lsid:marinepecies.org:taxname:103356",
    scientificName == "Oithona" ~ "urn:lsid:marinespecies.org:taxname:106485",
    scientificName == "Paracalanus" ~ "urn:lsid:marinespecies.org:taxname:104196",
    scientificName == "Podon" ~ "urn:lsid:marinespecies.org:taxname:106269", 
    scientificName == "Paraeuchaeta elongata" ~ "urn:lsid:marinespecies.org:taxname:196779",
    scientificName == "Cnidaria" ~ "urn:lsid:marinespecies.org:taxname:1267",
    scientificName == "Gammaroidea" ~ "urn:lsid:marinespecies.org:taxname:720708",
    scientificName == "Tunicata" ~ "urn:lsid:marinespecies.org:taxname:146420",
    scientificName == "Metridia pacifica" ~ "urn:lsid:marinespecies.org:taxname:196784",
    scientificName == "Neocalanus flemingeri" ~ "urn:lsid:marinespecies.org:taxname:353708",
    scientificName == "Callianassa" ~ "urn:lsid:marinespecies.org:taxname:107072",
    scientificName == "Calanus" ~ "urn:lsid:marinespecies.org:taxname:104152",
    scientificName == "Fritillaria" ~ "urn:lsid:marinespecies.org:taxname:103358",
    scientificName == "Oncaea" ~ "urn:lsid:marinespecies.org:taxname:128690",
    scientificName == "Pseudocalanus" ~ "urn:lsid:marinespecies.org:taxname:104165",
    scientificName == "Pseudocalanus newmani" ~ "urn:lsid:marinespecies.org:taxname:157679",
    scientificName == "Neocalanus" ~ "urn:lsid:marinespecies.org:taxname:104155",
    scientificName == "Harpacticoida" ~ "urn:lsid:marinespecies.org:taxname:1102",
    scientificName == "Mesocalanus tenuicornis" ~ "urn:lsid:marinespecies.org:taxname:104468",
    scientificName == "Gaetanus brevispinus" ~ "urn:lsid:marinespecies.org:taxname:254602",
    scientificName == "Conchoecia" ~ "urn:lsid:marinespecies.org:taxname:127533",
    scientificName == "Metridia okhotensis" ~ "urn:lsid:marinespecies.org:taxname:196783",
    scientificName == "Nudibranchia" ~ "urn:lsid:marinespecies.org:taxname:1762",
    scientificName == "Isopoda" ~ "urn:lsid:marinespecies.org:taxname:1131",
    scientificName == "Mysida" ~ "urn:lsid:marinespecies.org:taxname:149668",
    scientificName == "Salpidae" ~ "urn:lsid:marinespecies.org:taxname:137217",
    scientificName == "Pterotracheoidea" ~ "urn:lsid:marinespecies.org:taxname:387338",
    scientificName == "Clione" ~ "urn:lsid:marinespecies.org:taxname:137793",
    scientificName == "Hyperioides" ~ "urn:lsid:marinespecies.org:taxname:101797",
    scientificName == "Hyperoche medusarum" ~ "urn:lsid:marinespecies.org:taxname:103256",
    scientificName == "Hyperia spinigera" ~ "urn:lsid:marinespecies.org:taxname:103254",
    scientificName == "Ammodytidae" ~ "urn:lsid:marinespecies.org:taxname:125516",
    scientificName == "Sebastes" ~ "urn:lsid:marinespecies.org:taxname:126175",
    scientificName == "Podothecus" ~ "urn:lsid:marinespecies.org:taxname:254386",
    scientificName == "Hemilepidotus hemilepidotus" ~ "urn:lsid:marinespecies.org:taxname:254521",
    scientificName == "Maurolicus japonicus" ~ "urn:lsid:marinespecies.org:taxname:274972",
    scientificName == "Hydrozoa" ~ "urn:lsid:marinespecies.org:taxname:1337",
    scientificName == "Pseudocalanus elongatus" ~ "urn:lsid:marinespecies.org:taxname:104515",
    scientificName == "Microcalanus" ~ "urn:lsid:marinespecies.org:taxname:104164",
    scientificName == "Oithona similis" ~ "urn:lsid:marinespecies.org:taxname:106656",
    scientificName == "Microsetella norvegica" ~ "urn:lsid:marinespecies.org:taxname:116115",
    scientificName == "Gammarus" ~ "urn:lsid:marinespecies.org:taxname:101537",
    scientificName == "Phronima sedentaria" ~ "urn:lsid:marinespecies.org:taxname:103272",
    scientificName == "Paralithodes camtschaticus" ~ "urn:lsid:marinespecies.org:taxname:233889",
    scientificName == "Gymnocanthus detrisus" ~ "urn:lsid:marinespecies.org:taxname:274372",
    scientificName == "Trichodontidae" ~ "urn:lsid:marinespecies.org:taxname:151408",
    scientificName == "Oligochaeta" ~ "urn:lsid:marinespecies.org:taxname:2036",
    scientificName == "Neomysis" ~ "urn:lsid:marinespecies.org:taxname:119888", 
    scientificName == "Diptera" ~ "urn:lsid:marinespecies.org:taxname:118088",
    scientificName == "Aglantha" ~ "urn:lsid:marinespecies.org:taxname:117212")) %>%
  distinct()

# Check to see if there are any scientificNames that have not received an associated scientificNameID. If there are any for which there is no scientificNameID, these will have to be created manually along with the taxonomic information in their respective columns, and "vernacularName". 
missing_scientificNameID <- NPMSDD_occ[is.na(NPMSDD_occ$scientificNameID),]
Coelenterata <- missing_scientificNameID %>%
  mutate(vernacularName = case_when(
    scientificName == "Coelenterata" ~ "Coelenterata spp."),
         prey_kingdom = case_when(
    scientificName == "Coelenterata" ~ "Animalia"),
         scientificNameID = case_when(
    scientificName == "Coelenterata" ~ "urn:lsid:marinespecies.org:taxname:2"
         )
  )

# Add this dataframe to the original NPMSDD_occ dataframe. 
NPMSDD_occ <- plyr::rbind.fill(NPMSDD_occ, Coelenterata)

# Create occurrence core for the predators. Please note that no columns are provided for kingdom, phylum, class, order, family, genus or species. Therefore these have to be added manually:

predator_occ <- NPMSDD_occ %>% 
  dplyr::select(eventID, predator_lowest_taxonomic_level, predator_id, lat_min, lat_max, lon_min, lon_max, 
                year_min, year_max, warm_cool_years, odd_even_years, season_min, season_max, 
                month_min, month_max, date_min, time_min, time_max, gear_type_predator_id1, gear_type_predator_id2,
                gear_type_predator_id3, gear_type_predator_id4, gear_type_predator_id5) %>%
  dplyr::rename(scientificName = predator_lowest_taxonomic_level) %>%
  mutate(occurrenceStatus = "present",
         occurrenceID = paste(eventID, "p", sep = "-")) %>% 
  # I like to add this line to indicate that its the predator. 
  mutate(scientificNameID = case_when(
    scientificName == "Oncorhynchus keta" ~ "urn:lsid:marinespecies.org:taxname:127183",
    scientificName == "Oncorhynchus nerka" ~ "urn:lsid:marinespecies.org:taxname:254569",
    scientificName == "Oncorhynchus gorbuscha" ~ "urn:lsid:marinespecies.org:taxname:127182",
    scientificName == "Oncorhynchus kisutch" ~ "urn:lsid:marinespecies.org:taxname:127184",
    scientificName == "Oncorhynchus mykiss" ~ "urn:lsid:marinespecies.org:taxname:127185",
    scientificName == "Oncorhynchus tshawytscha" ~ "urn:lsid:marinespecies.org:taxname:158075")
  ) %>% 
  mutate(kingdom = "Animalia",
         phylum = "Chordata",
         class = "Actinopterygii",
         order = "Salmoniformes",
         family = "Salmonidae",
         genus = "Oncorhynchus") %>%
  mutate(specificEpithet = scientificName,
         specificEpithet = gsub("Oncorhynchus ", "", specificEpithet)) %>%
    select(-predator_id) %>%
  distinct()

prey_occ <- NPMSDD_occ %>%
    dplyr::select(eventID, occurrenceID, occurrenceStatus, lat_min, lat_max, lon_min, lon_max, year_min, year_max, 
                            warm_cool_years, odd_even_years, season_min, season_max,
                            month_min, month_max, date_min, time_min, time_max, scientificName, scientificNameID,
                            prey_kingdom, prey_phylum, prey_class, prey_order, prey_family, prey_genus, prey_species,
                            gear_type_predator_id1, gear_type_predator_id2, gear_type_predator_id3,
                            gear_type_predator_id4, gear_type_predator_id5) %>%
    dplyr::rename(kingdom = prey_kingdom,
                phylum = prey_phylum,
                class = prey_class,
                order = prey_order,
                family = prey_family,
                genus = prey_genus,
                specificEpithet = prey_species)

# Bind rows
NPMSDD_occ <- bind_rows(prey_occ, predator_occ)


# To re-order the eventID, use following code:
order <- stringr::str_sort(NPMSDD_occ$occurrenceID, numeric=TRUE)
NPMSDD_occ <- NPMSDD_occ[match(order, NPMSDD_occ$occurrenceID),]
```

After we've created the NPMSDD Occurrence Core, we can associate each `occurrenceID` with its respective spatio-temporal information:

``` {r NPMSDD_coordinates, eval = FALSE}
coordinates <- NPMSDD_occ %>%
  select(occurrenceID,lat_min, lat_max, lon_min, lon_max) %>%
  mutate(footprintWKT = " ") %>%
  mutate(lat_min = as.numeric(lat_min),
         lat_max = as.numeric(lat_max),
         lon_min = as.numeric(lon_min),
         lon_max = as.numeric(lon_max))

coordinates$lon_max <- ifelse(coordinates$lon_max >= 180, coordinates$lon_max - 360, coordinates$lon_max)
coordinates$lon_max <- ifelse(coordinates$lon_max > 0, -coordinates$lon_max, coordinates$lon_max)
coordinates$lon_min <- ifelse(coordinates$lon_min >= 180, coordinates$lon_min - 360, coordinates$lon_min)
coordinates$lon_min <- ifelse(coordinates$lon_min > 0, -coordinates$lon_min, coordinates$lon_min)

coordinates$footprintWKT <- ifelse(!is.na(coordinates$lat_max & coordinates$lon_max), "POLYGON", 
                                   ifelse(is.na(coordinates$lat_max | coordinates$lon_max), "POINT", "LINESTRING"))

point_coordinates <- coordinates %>% filter(footprintWKT == "POINT") %>%
mutate(footprintWKT = paste0("POINT", " (", lon_min, " ", lat_min, ")")) 
point <- obistools::calculate_centroid(point_coordinates$footprintWKT)
point <- cbind(point_coordinates, point)

polygon_coordinates <- coordinates %>% filter(footprintWKT == "POLYGON") %>%
  mutate(footprintWKT = paste("POLYGON ((", lon_min, lat_min, ",",
                                lon_min, lat_max, ",",
                                lon_max, lat_min, ",",
                                lon_max, lat_max, ",",
                                lon_min, lat_min, "))"))
polygon <- obistools::calculate_centroid(polygon_coordinates$footprintWKT)
polygon <- cbind(polygon_coordinates, polygon)

# Two datasets for LINESTRING, one where lat_max is NA, and another lon_max is NA. 
linestring_coordinates_1 <- coordinates %>% filter(footprintWKT == "LINESTRING") %>% filter(is.na(lat_max)) %>%
  mutate(footprintWKT = paste("LINESTRING (", lon_min, lat_min, ",", lon_max, lat_min, ")"))
linestring_coordinates_2 <- coordinates %>% filter(footprintWKT == "LINESTRING") %>%  filter(is.na(lon_max)) %>%
  mutate(footprintWKT = paste("LINESTRING (", lon_min, lat_min, ",", lon_min, lat_max, ")"))
linestring_coordinates <- rbind(linestring_coordinates_1, linestring_coordinates_2)
linestring <- obistools::calculate_centroid(linestring_coordinates$footprintWKT) 
linestring <- cbind(linestring_coordinates, linestring)

event_coordinates <- rbind(point, polygon, linestring) %>%
  select(footprintWKT, decimalLatitude, decimalLongitude, coordinateUncertaintyInMeters)

NPMSDD_occ <- cbind(NPMSDD_occ, event_coordinates)
```

And the associated dates and times:

``` {r NPMSDD_eventDate, eval = FALSE}
occdate <- NPMSDD_occ %>%
  select(eventID, occurrenceID, year_min, year_max, warm_cool_years, odd_even_years, season_min, season_max,
         month_min, month_max, date_min, time_min, time_max) %>%
  mutate(month_min = case_when(
    month_min == "January" ~ "01",
    month_min == "February" ~ "02",
    month_min == "March" ~ "03",
    month_min == "April" ~ "04",
    month_min == "May" ~ "05",
    month_min == "June" ~ "06",
    month_min == "July" ~ "07",
    month_min == "August" ~ "08", 
    month_min == "September" ~ "09",
    month_min == "October" ~ "10",
    month_min == "November" ~ "11",
    month_min == "December" ~ "12"),
    month_max = case_when(
    month_max == "January" ~ "01",
    month_max == "February" ~ "02",
    month_max == "March" ~ "03",
    month_max == "April" ~ "04",
    month_max == "May" ~ "05",
    month_max == "June" ~ "06",
    month_max == "July" ~ "07",
    month_max == "August" ~ "08", 
    month_max == "September" ~ "09",
    month_max == "October" ~ "10",
    month_max == "November" ~ "11",
    month_max == "December" ~ "12"))

# Step 1: If an occurrenceID has a single associated date_min, this becomes the eventDate. Similarly, if only a year_min is provided for the occurrenceID, this becomes the eventDate. 

dates <- occdate %>% filter(!is.na(date_min)) %>% 
  mutate(year = year_min, 
         month = month_min,
         eventDate = date_min)
dates <- dates %>% 
  mutate(eventDate = as.character(eventDate))

year <- occdate %>% filter(is.na(date_min) & is.na(month_min) & is.na(year_max) & is.na(season_min)) %>%
  mutate(eventDate = year_min,
         year = year_min)

# A range in years is depicted using the following code; though it's currently not required. 
year_range <- occdate %>% filter(is.na(date_min) & !is.na(year_max) & is.na(month_min) & is.na(season_min)) %>%
  mutate(eventDate = paste(year_min, year_max, sep = " - "))

# Step 2: Months. If a date_min is not provided within every data entry for a specific sourceID, the eventDate will have to be recorded on a different granularity. The first is to remove all the eventIDs from the the dates dataframe from the original 'eventdate' dataframe. We need to make sure that if months or years are represented as a range, this is accurately displayed in eventDate. 

months <- anti_join(occdate, dates, by = "occurrenceID") %>% filter(!is.na(month_min))

months_single <- months %>% filter(is.na(year_max) & is.na(month_max)) %>% 
  mutate(eventDate = paste(year_min, month_min, sep = "-"),
         year = year_min)
month_range <- months %>% filter(is.na(year_max) & !is.na(month_max)) %>%
  mutate(eventDate = paste(year_min, month_min, sep = "-"),
         eventDate = paste(eventDate, month_max, sep = "/"),
         year = year_min)
year_range <- months %>% filter(!is.na(year_max) & is.na(month_max)) %>%
  mutate(eventDate = paste(year_min, year_max, sep = "/"),
         eventDate = paste(eventDate, month_min, sep = "-"))
month_year_range <- months %>% filter(!is.na(year_max) & !is.na(month_max)) %>%
  mutate(eventDate = paste(year_min, year_max, sep = "/"),
         eventDate = paste(eventDate, month_min, sep = "-"),
         eventDate = paste(eventDate, month_max, sep = "/"))

months <- plyr::rbind.fill(months_single, month_range, year_range, month_year_range)

seasons <- occdate %>% filter(!is.na(season_min))

season_single_year <- seasons %>% filter(is.na(year_max)) %>%
  mutate(verbatimEventDate = paste(season_min, year_min, sep = " - "),
         year = year_min)
season_years <- seasons %>% filter(!is.na(year_max)) %>%
  mutate(verbatimEventDate = paste(season_min, year_min, sep = " - "),
         verbatimEventDate = paste(verbatimEventDate, year_max, sep = "/"))

seasons <- plyr::rbind.fill(season_single_year, season_years)

date <- plyr::rbind.fill(dates, year, months, seasons) %>%
  select(occurrenceID, eventDate, verbatimEventDate, year, month)

NPMSDD_occ <- left_join(NPMSDD_occ, date, by = "occurrenceID") %>%
  select(eventID, occurrenceID, eventDate, verbatimEventDate, year, month, decimalLatitude, decimalLongitude, footprintWKT, coordinateUncertaintyInMeters, scientificName, scientificNameID, occurrenceStatus, kingdom, phylum, class, order, family, genus, specificEpithet, gear_type_predator_id1, gear_type_predator_id2, gear_type_predator_id3, gear_type_predator_id4, gear_type_predator_id5) %>%
  mutate(basisOfRecord = "HumanObservation",
         geodeticDatum = "EPSG:4326")
```

Given that we are dealing with predator-prey data, we add an additional column `associatedTaxa` to indicate which species are predators and which are prey, and how these are linked.  

``` {r associatedTaxa, eval = FALSE}
NPMSDD_occ$associatedTaxa <-   " "
NPMSDD_occ$associatedTaxa <- ifelse(grepl("-pr", NPMSDD_occ$occurrenceID), 
paste("prey of: ", NPMSDD_occ$eventID, "-p", sep = ""), "")
```

Although it is not a required term in the DwC standards, minimumDepthInMeters and maximumDepthInMeters are recorded as 'missing' if not provided. The information regarding sampling depth is recorded in the `gear_type_predator` file, and - depending on what gear was used - is listed under one of the following columns: gear_depth_value, gear_depth_min, fishing_depth_value and fishing_depth_min. Therefore, to obtain the minimumDepthInMeters, first the data from the gear_type_predator dataframe is joined with our initial NPMSDD_Occ dataframe. 

``` {r sampling depth, eval = FALSE}
sampling_gears <- NPMSDD_occ %>%
  select(occurrenceID, 
         gear_type_predator_id1, gear_type_predator_id2,
         gear_type_predator_id3, gear_type_predator_id4, gear_type_predator_id5) %>%
  pivot_longer(cols = gear_type_predator_id1:gear_type_predator_id5,
               values_to = "gear_type_predator_id",
               names_to = "gear") %>%
  select(occurrenceID, gear_type_predator_id) %>%
  filter(!is.na(gear_type_predator_id)) %>%
  distinct()

sampling_depth <- read_csv(here::here("datasets", "npmsdd_data_from_caroline", "gear_type_predator.csv"), 
                 col_types = "icnnncnnncnnncnnncnnncnnncnnncc") %>% 
  select(gear_type_predator_id, gear_depth_value, gear_depth_min, fishing_depth_value, 
         fishing_depth_min, gear_depth_max, fishing_depth_max)
  
depth <- left_join(sampling_gears, sampling_depth, by = "gear_type_predator_id") %>%
  transform(minimumDepthInMeters = pmin(gear_depth_value, gear_depth_min, 
                                        fishing_depth_value, fishing_depth_min, na.rm = TRUE),
            maximumDepthInMeters = pmax(gear_depth_value, gear_depth_max, 
                                        fishing_depth_value, fishing_depth_max, na.rm = TRUE)) %>%
  group_by(occurrenceID) %>% 
  mutate(minimumDepthInMeters = min(minimumDepthInMeters),
         maximumDepthInMeters = max(maximumDepthInMeters)) %>%
  select(occurrenceID, minimumDepthInMeters, maximumDepthInMeters) %>% distinct()

NPMSDD_occ <- left_join(NPMSDD_occ, depth, by = "occurrenceID") %>%
  select(-gear_type_predator_id1:-gear_type_predator_id5)

write_csv(NPMSDD_occ, here::here("datasets", "npmsdd_data_from_caroline", 
                                  "NPMSDD_occ.csv"))
```

To save any maps etc, use the following chunk of code:

``` {r save_plots_images}
obistools::plot_map(NPMSDD_occ, zoom = TRUE)
ggsave(here::here("datasets", "npmsdd_data_from_caroline", "NPMSDD_occurrence.png"))
```

To do: add in some fail safes. Furthermore, an extended Measurement Or Fact (eMOF) Core can be added as well, linking to the `occurrenceID`. Information in the eMOF core can be i.e. length and weight measurements associated to both the predators and the prey. 

``` {r fail safes, eval = FALSE}
# Ensure that occurrenceIDs are unique (i.e. no duplicates):
NPMSDD_occ[dupliated(NPMSDD_occ$occurrenceID),]

# Ensure that all occurrenceIDs have an associated eventDate:
missing_eventDate <- NPMSDD_occ[is.na(NPMSDD_occ$eventDate),]

```

