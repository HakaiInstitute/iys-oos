---
title: "2020 IYS HPLC"
author: "Tim van der Stap"
date: "12/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
library(tidyverse)
library(lubridate)
library(obistools)
library(readxl)
library(parsedate)
library(googledrive)
library(here)
```

``` {r, eval = FALSE}

drive_download("https://docs.google.com/spreadsheets/d/1w7kXZvU7OpmJjBTKAMPGhJblfcF8cN74/edit#gid=989173203",
               path = here("Oceanography", "HPLC", "Metadata.xlsx"))

HPLC <- read_excel(here("Oceanography", "HPLC", "Metadata.xlsx"), sheet = "HPLC samples") %>% 
  mutate(Time = format(Time, "%H:%M:%S"),
         eventDate = format_iso_8601(as.POSIXct(paste(Date, Time),
                                                format = "%Y-%m-%d %H:%M:%S",
                                                tz = "Asia/Kamchatka")),
         eventDate = str_replace(eventDate, "\\+00:00", "Z"),
         cruise = "GoA2020",
         station = paste(cruise, Station, sep = "_Stn:"),
         cast = paste(station, "cast1", sep = ":"),
         ndepth = paste(cast, `Sample depth_m`, sep = ":niskin:"),
         sample = paste(ndepth, `Sample ID`, sep = ":"))
```

## Event Core

``` {r, eval = FALSE}

hplc2020_cruise <- HPLC %>%
  select(eventID = cruise) %>%
  distinct(eventID) %>%
  mutate(eventRemarks = "cruise")

hplc2020_station <- HPLC %>%
  select(eventID = station,
         parentEventID = cruise) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate(eventRemarks = "station")

hplc2020_cast <- HPLC %>%
  select(eventID = cast,
         parentEventID = station,
         eventDate,
         decimalLatitude = Latitude,
         decimalLongitude = Longitude) %>%
  mutate(decimalLongitude = as.numeric(decimalLongitude),
         decimalLatitude = as.numeric(decimalLatitude)) %>%
  distinct(eventID, .keep_all = TRUE)

hplc2020_cast <- hplc2020_cast %>%
  mutate(footprintWKT = paste("POINT", " (", hplc2020_cast$decimalLongitude,
                              " ", hplc2020_cast$decimalLatitude, ")"),
         eventRemarks = "cast")

coordinates <- obistools::calculate_centroid(hplc2020_cast$footprintWKT) %>% select(coordinateUncertaintyInMeters)
hplc2020_cast <- cbind(hplc2020_cast, coordinates)

hplc2020_depth <- HPLC %>%
  select(eventID = ndepth,
         parentEventID = ndepth,
         minimumDepthInMetres = `Sample depth_m`,
         maximumDepthInMetres = `Sample depth_m`) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate(eventRemarks = "sample")

hplc2020_sample <- HPLC %>%
  select(eventID = sample,
         parentEventID = ndepth,
         samplingEffort = `Volume filtered_mL`) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate(eventRemarks = "subsample")

hplc2020_event <- bind_rows(hplc2020_cruise, hplc2020_station, hplc2020_cast, hplc2020_depth, hplc2020_sample) %>%
  select(eventID, parentEventID:maximumDepthInMetres, coordinateUncertaintyInMeters, eventRemarks) %>%
  mutate(type = "Event", 
         geodeticDatum = "EPSG:4326 WGS84")

obistools::check_eventids(hplc2020_event)

write_csv(hplc2020_event, here("Oceanography", "HPLC", "tidy_data", "hplc2020_event.csv"))
```

