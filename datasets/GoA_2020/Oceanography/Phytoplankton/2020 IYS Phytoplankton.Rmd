---
title: "2020 IYS Phytoplankton"
author: "Tim van der Stap"
date: "12/8/2020"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
library(tidyverse)
library(lubridate)
library(obistools)
library(readxl)
library(parsedate)
library(googledrive)
library(here)
```

``` {r, eval = FALSE}

drive_download("https://docs.google.com/spreadsheets/d/10GgZfRCA2bPiwFJAPHR04D-UMCxgvCZP/edit#gid=70264570",
               path = here("Oceanography", "Phytoplankton", "Metadata.xlsx"))

Phyto <- read_excel(here("Oceanography", "Phytoplankton", "Metadata.xlsx"), sheet = "PHYTO samples") %>% 
  mutate(Time = format(Time, "%H:%M:%S"),
         eventDate = format_iso_8601(as.POSIXct(paste(Date, Time),
                                                format = "%Y-%m-%d %H:%M:%S",
                                                tz = "Asia/Kamchatka")),
         eventDate = str_replace(eventDate, "\\+00:00", "Z"),
         cruise = "GoA2020",
         station = paste(cruise, Station, sep = "_Stn:"),
         cast = paste(station, "cast1", sep = ":"),
         ndepth = paste(cast, `Sample depth_m`, sep = ":niskin:"),
         sample = paste(ndepth, `Sample ID`, sep = ":"))
```

## Event Core

``` {r, eval = FALSE}

phyto2020_cruise <- Phyto %>%
  select(eventID = cruise) %>%
  distinct(eventID) %>%
  mutate(eventRemarks = "cruise")

phyto2020_station <- Phyto %>%
  select(eventID = station,
         parentEventID = cruise) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate(eventRemarks = "station")

phyto2020_cast <- Phyto %>%
  select(eventID = cast,
         parentEventID = station,
         eventDate,
         decimalLatitude = Latitude,
         decimalLongitude = Longitude) %>%
  mutate(decimalLongitude = as.numeric(decimalLongitude),
         decimalLatitude = as.numeric(decimalLatitude)) %>%
  distinct(eventID, .keep_all = TRUE)

phyto2020_cast <- phyto2020_cast %>%
  mutate(footprintWKT = paste("POINT", " (", phyto2020_cast$decimalLongitude,
                              " ", phyto2020_cast$decimalLatitude, ")"),
         eventRemarks = "cast")

coordinates <- obistools::calculate_centroid(phyto2020_cast$footprintWKT) %>% select(coordinateUncertaintyInMeters)
phyto2020_cast <- cbind(phyto2020_cast, coordinates)

phyto2020_depth <- Phyto %>%
  select(eventID = ndepth,
         parentEventID = ndepth,
         minimumDepthInMetres = `Sample depth_m`,
         maximumDepthInMetres = `Sample depth_m`) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate(eventRemarks = "sample")

phyto2020_sample <- Phyto %>%
  select(eventID = sample,
         parentEventID = ndepth,
         samplingEffort = `Volume sample_mL`) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate(eventRemarks = "subsample")

phyto2020_event <- bind_rows(phyto2020_cruise, phyto2020_station,
                             phyto2020_cast, phyto2020_depth, phyto2020_sample) %>%
  select(eventID, parentEventID:maximumDepthInMetres, coordinateUncertaintyInMeters, eventRemarks) %>%
  mutate(type = "Event", 
         geodeticDatum = "EPSG:4326 WGS84")

obistools::check_eventids(phyto2020_event)

write_csv(phyto2020_event, here("Oceanography", "Phytoplankton", "tidy_data", "phyto2020_event.csv"))
```
